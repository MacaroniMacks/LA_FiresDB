<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neighbor Dashboard</title>
    <link rel="stylesheet" href="/static/css/neighborDash.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">EnergyBalance</div>
        <div class="nav-links">
            <span id="userEmail"></span>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>              
    </nav>

    <div class="dashboard-container">
        <div id="campaigns" class="tab-content">
            <div id="requestsList">
                <!-- Requests will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>

    <!-- Auth -->
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>

    <script>
        // Function to create a request card
        function createRequestCard(request) {
            return `
                <div class="request-card">
                    <div class="request-info">
                        <h3>${request.companyName} wants ${request.targetUsers} users in your area</h3>
                        <p>Reward: $${request.rewardAmount}</p>
                    </div>
                    <div class="join-action">
                        <button class="join-btn" onclick="joinRequest('${request.id}')">Join</button>
                        <div class="join-count">${request.currentParticipants}/${request.targetUsers}</div>
                    </div>
                </div>
            `;
        }

        // Function to load requests
        async function loadRequests() {
            try {
                console.log('Loading requests...');
                const user = firebase.auth().currentUser;
                const userDoc = await firebase.firestore()
                    .collection('users')
                    .doc(user.uid)
                    .get();
                const userData = userDoc.data();
                const userRegion = userData.region;

                const requestsSnapshot = await firebase.firestore()
                    .collection('requests')
                    .where('city', '==', userRegion)
                    .where('status', '==', 'active')
                    .get();

                const requestsContainer = document.getElementById('requestsList');
                requestsContainer.innerHTML = '';

                requestsSnapshot.forEach(doc => {
                    const requestData = doc.data();
                    requestData.id = doc.id;
                    requestsContainer.innerHTML += createRequestCard(requestData);
                });
                console.log('Requests loaded successfully');
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        // Function to join a request
        async function joinRequest(requestId) {
            try {
                const user = firebase.auth().currentUser;
                await firebase.firestore().collection('participations').add({
                    userId: user.uid,
                    requestId: requestId,
                    status: 'joined',
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const requestRef = firebase.firestore().collection('requests').doc(requestId);
                await requestRef.update({
                    currentParticipants: firebase.firestore.FieldValue.increment(1)
                });

                await loadRequests();
            } catch (error) {
                console.error('Error joining request:', error);
                alert('Failed to join request');
            }
        }

        // Initialize dashboard
        // At the top of your dashboard page scripts
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Get token
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.log('No token found');
                    window.location.href = '/login';
                    return;
                }

                // Set up auth header for all fetch requests first
                const originalFetch = window.fetch;
                window.fetch = function() {
                    let [resource, config] = arguments;
                    config = config || {};
                    config.headers = config.headers || {};
                    config.headers['Authorization'] = `Bearer ${token}`;
                    return originalFetch(resource, config);
                };

                // Then set up Firebase auth listener
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        const userDoc = await firebase.firestore()
                            .collection('users')
                            .doc(user.uid)
                            .get();
                        
                        const userData = userDoc.data();
                        document.getElementById('userEmail').textContent = user.email;

                        if (userData.isDonationCenter) {
                            window.location.href = '/donation-center-dashboard';
                        } else {
                            await loadRequests();
                        }
                    }
                    // Don't redirect to login here - just don't load requests
                });

            } catch (error) {
                console.error('Dashboard initialization error:', error);
                window.location.href = '/login';
            }
        });
    </script>
</body>
</html>