<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neighbor Dashboard</title>
    <link rel="stylesheet" href="/static/css/neighborDash.css">
    <link rel="stylesheet" href="/static/css/item-dropdown-styles.css">
    <script src="/static/js/item-searchable-dropdown.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">Help626</div>
        <div class="nav-links">
            <a href="#" id="userEmail" onclick="goToProfile(event)"></a>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>              
    </nav>

    <div class="dashboard-container">
        <div class="filter-section">
            <select id="radiusFilter" onchange="updateDonationCenters(userData)">
                <option value="5">Within 5 miles</option>
                <option value="10">Within 10 miles</option>
                <option value="25">Within 25 miles</option>
                <option value="50">Within 50 miles</option>
                <option value="999">Any distance</option>
            </select>
        </div>

        <div id="donationCentersList" class="centers-list">
            <!-- Centers will be loaded here dynamically -->
        </div>
    </div>

   <!-- Firebase SDKs -->
   <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

   <!-- Firebase Config -->
   <script src="{{ url_for('static', filename='js/config.js') }}"></script>

   <!-- Auth -->
   <script src="{{ url_for('static', filename='js/auth.js') }}"></script>

   <script>
let userLocation = null;

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 3959; // Earth's radius in miles
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function toRad(degrees) {
    return degrees * (Math.PI/180);
}

function convertTo12HourFormat(time) {
    if (!time) return '';
    let [hour, minute] = time.split(':');
    hour = parseInt(hour);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    hour = hour % 12;
    hour = hour ? hour : 12; // the hour '0' should be '12'
    minute = minute.padStart(2, '0');
    return `${hour}:${minute} ${ampm}`;
}

function generateHoursHTML(hours, centerId) {
    if (!hours) return '';
    
    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

     // Check if any days have hours set
     const hasAnyHours = days.some(day => {
        const dayHours = hours[day];
        return dayHours && dayHours.open && dayHours.close;
    });

    // If no days have hours set, don't return any hours display
    if (!hasAnyHours) {
        return '';
    }

    const currentDay = days[new Date().getDay()];
    const todayHours = hours[currentDay];
    let statusText = 'Closed';
    
    if (todayHours?.open && todayHours?.close) {
        statusText = `Open ${convertTo12HourFormat(todayHours.open)} - ${convertTo12HourFormat(todayHours.close)}`;
    }

    const popupContent = days.map(day => {
        const dayHours = hours[day];
        if (dayHours?.open && dayHours?.close) {
            return `<div class="day-hours">
                ${day.charAt(0).toUpperCase() + day.slice(1)}: 
                ${convertTo12HourFormat(dayHours.open)} - ${convertTo12HourFormat(dayHours.close)}
            </div>`;
        }
        return `<div class="day-hours">${day.charAt(0).toUpperCase() + day.slice(1)}: Closed</div>`;
    }).join('');

    return `
        <div class="center-hours">
            <h4>${statusText}</h4>
            <div class="hours-popup">
                <div class="hours-content">
                    ${popupContent}
                </div>
            </div>
        </div>
    `;
}

async function updateDonationCenters(userData) {

    
    console.log('Starting updateDonationCenters');
    const radius = parseFloat(document.getElementById('radiusFilter').value);
    
    try {
        const centersSnapshot = await firebase.firestore()
            .collection('users')
            .where('isDonationCenter', '==', true)
            .get();

        const centersList = document.getElementById('donationCentersList');
        centersList.innerHTML = '';

        centersSnapshot.forEach(doc => {
            const centerData = doc.data();
            
            console.log('Full center data:', centerData);
            console.log('Operating Hours:', centerData.operatingHours);
            
            if (!centerData.location) return;

            const distance = calculateDistance(
                userLocation.latitude,
                userLocation.longitude,
                centerData.location.latitude,
                centerData.location.longitude
            );

            if (distance <= radius || radius === 999) {
                const centerCard = document.createElement('div');
                centerCard.className = 'center-card';
                
                const hasAddress = centerData.addressInfo.street != null;


            centerCard.innerHTML = `
                <div class="center-header">
                    <div class="center-main-info">
                        <h3>${centerData.centerName || 'Unnamed Center'}</h3>
                        ${centerData.contactInfo?.phone ? 
                            `<p class="contact-detail">${centerData.contactInfo.phone}</p>` : ''}
                        ${centerData.contactInfo?.email ? 
                            `<p class="contact-detail">${centerData.contactInfo.email}</p>` : ''}
                    </div>
                    <div class="center-location">
                        <div class="location-info">
                ${hasAddress ? `
                    <div class="address-wrapper" style="display: flex;">    
                        <svg class="location-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span>${[
                            centerData.addressInfo.street,
                            centerData.addressInfo.unit ? `Unit ${centerData.addressInfo.unit}` : null,
                            centerData.addressInfo.city,
                            centerData.addressInfo.zipCode
                        ].filter(Boolean).join(', ')}</span>
                    </div>
                    <span class="dot-separator" style="display: block;"></span>
                ` : ''}
                <span class="distance">${distance.toFixed(1)} miles away</span>
            </div>
            ${generateHoursHTML(centerData.operatingHours, doc.id)}
        </div>
    </div>

    ${centerData.centerNotes ? `
        <div class="additional-info">
            <h4>Additional Information</h4>
            <p>${centerData.centerNotes}</p>
        </div>
    ` : ''}

    <div class="matches-container">
        <div class="matches-section matches-needs">
            <h4>Center's Inventory</h4>
            <ul>
                ${centerData?.inventory?.length > 0 ? 
                    centerData.inventory.map(item => `
                        <li>
                            <span class="match-item">${item.itemName || 'Unnamed Item'}</span>
                            ${item.quantity ? `<span class="match-quantity">(${item.quantity} available)</span>` : ''}
                        </li>
                    `).join('') : '<li class="no-matches">Center currently hasn\'t set up inventory</li>'
                }
            </ul>
        </div>
        <div class="matches-section matches-donations">
            <h4>Center's Needs</h4>
            <ul>
                ${centerData?.needs?.length > 0 ? 
                    centerData.needs.map(need => `
                        <li>
                            <span class="match-item">${need.itemName}</span>
                            ${need.quantity ? `<span class="match-quantity">(${need.quantity} needed)</span>` : ''}
                            ${need.urgency ? `<span class="urgency-tag ${need.urgency}-urgency">${need.urgency} urgency</span>` : ''}
                        </li>
                    `).join('') : '<li class="no-matches">Center currently hasn\'t set up needs</li>'
                }
            </ul>
        </div>
    </div>
`;
                highlightMatchingItems(userData, centerData);
                
                centersList.appendChild(centerCard);
            }
        });

        if (centersList.children.length === 0) {
            centersList.innerHTML = `
                <div class="no-centers">
                    No donation centers found within ${radius} miles
                </div>
            `;
        }

    } catch (error) {
        console.error('Error fetching donation centers:', error);
    }
}

// New inline hours update function

function updateCenterHoursInline(operatingHours, hoursId) {
    console.log('Updating hours inline for hoursId:', hoursId);
    
    // Find status and hours elements using specific selectors
    const statusEl = document.getElementById(`${hoursId}-status`);
    const hoursEl = document.getElementById(`${hoursId}-hours`);

    // Validate elements exist
    if (!statusEl || !hoursEl) {
        console.error('Could not find status or hours elements', {
            hoursId: hoursId,
            statusEl: !!statusEl,
            hoursEl: !!hoursEl,
            statusElExists: document.getElementById(`${hoursId}-status`) !== null,
            hoursElExists: document.getElementById(`${hoursId}-hours`) !== null
        });
        return;
    }

    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const currentDay = days[new Date().getDay()];
    const currentDate = new Date();
    
    // Use the exact field names from your Firebase structure
    const todayHours = operatingHours[currentDay];

    let hoursStatus = 'Closed';

    if (todayHours && todayHours.open && todayHours.close) {
        const [openHour, openMinute] = todayHours.open.split(':').map(Number);
        const [closeHour, closeMinute] = todayHours.close.split(':').map(Number);
        
        const openTime = new Date();
        openTime.setHours(openHour, openMinute, 0);
        
        const closeTime = new Date();
        closeTime.setHours(closeHour, closeMinute, 0);

        // Handle cases where closing time is past midnight
        if (closeTime < openTime) {
            closeTime.setDate(closeTime.getDate() + 1);
        }

        if (currentDate >= openTime && currentDate <= closeTime) {
            hoursStatus = `Open until ${convertTo12HourFormat(todayHours.close)}`;
        } else {
            // Find the next open day
            let foundOpenDay = false;
            
            // Check up to 7 days ahead
            for (let i = 0; i < 7; i++) {
                const checkIndex = (days.indexOf(currentDay) + i) % 7;
                const checkDay = days[checkIndex];
                const dayHours = operatingHours[checkDay];
                
                if (dayHours && dayHours.open) {
                    const [nextOpenHour, nextOpenMinute] = dayHours.open.split(':').map(Number);
                    const nextOpenTime = new Date();
                    
                    nextOpenTime.setHours(nextOpenHour, nextOpenMinute, 0);
                    
                    if (i === 0) {
                        // Today: only show if the opening time hasn't passed
                        if (currentDate < nextOpenTime) {
                            hoursStatus = `Closed until ${convertTo12HourFormat(dayHours.open)}`;
                            foundOpenDay = true;
                            break;
                        }
                    } else {
                        // Future days
                        nextOpenTime.setDate(nextOpenTime.getDate() + i);
                        if (i === 1) {
                            hoursStatus = `Closed until ${convertTo12HourFormat(dayHours.open)} tomorrow`;
                        } else {
                            const dayName = checkDay.charAt(0).toUpperCase() + checkDay.slice(1);
                            hoursStatus = `Closed until ${convertTo12HourFormat(dayHours.open)} ${dayName}`;
                        }
                        foundOpenDay = true;
                        break;
                    }
                }
            }
            
            if (!foundOpenDay) {
                hoursStatus = 'Closed';
            }
        }
    }

    // Update status
    statusEl.textContent = hoursStatus;

    // Populate full hours
    const fullHoursHTML = days.map(day => {
        const dayHours = operatingHours[day];
        if (dayHours?.open && dayHours?.close) {
            return `<div class="day-hours ${day === currentDay ? 'current-day' : ''}">
                ${day.charAt(0).toUpperCase() + day.slice(1)}: 
                ${convertTo12HourFormat(dayHours.open)} - ${convertTo12HourFormat(dayHours.close)}
            </div>`;
        }
        return `<div class="day-hours">${day.charAt(0).toUpperCase() + day.slice(1)}: Closed</div>`;
    }).join('');

    hoursEl.innerHTML = fullHoursHTML;
}


// Updated findMatches function with better null checks
function findMatches(userItems = [], centerItems = []) {
    if (!Array.isArray(userItems) || !Array.isArray(centerItems)) return [];
    
    return userItems.filter(userItem => 
        centerItems.some(centerItem => 
            userItem?.itemName?.toLowerCase() === centerItem?.itemName?.toLowerCase()
        )
    ).map(userItem => {
        const centerItem = centerItems.find(item => 
            item?.itemName?.toLowerCase() === userItem?.itemName?.toLowerCase()
        );
        return {
            ...centerItem,
            quantity: centerItem?.quantity || userItem?.quantity,
            itemName: userItem?.itemName || 'Unnamed Item'
        };
    });
}
function viewCenter(centerId) {
    // Implement center details view
    console.log('Viewing center:', centerId);
}

       document.addEventListener('DOMContentLoaded', async () => {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            console.log('No token found in URL');
            window.location.href = '/login';
            return;
        }

        await new Promise((resolve) => {
            const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                unsubscribe();
                resolve(user);
            });
        });

        const user = firebase.auth().currentUser;
        if (!user) {
            console.log('No user found');
            window.location.href = '/login';
            return;
        }

        const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
        const userData = userDoc.data();

        document.getElementById('userEmail').textContent = user.email;

        // Check and store user location
        userLocation = userData.location;
        if (!userLocation) {
            window.location.href = '/setup-location';
            return;
        }

        // Initialize centers list
        updateDonationCenters(userData);

        document.getElementById('radiusFilter').addEventListener('change', () => {
            updateDonationCenters(userData);  // Pass userData here too
        });

        // Show welcome popup if needed
        if ((!userData.canDonate || userData.canDonate.length === 0) && 
            (!userData.needs || userData.needs.length === 0)) {
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h2>Welcome!</h2>
                    <p>Let's get started by adding what you need or what you can donate.</p>
                    <div class="popup-buttons">
                        <button onclick="addNeeds()">Add Needs</button>
                        <button onclick="addDonations()">Add Donations</button>
                    </div>
                    <div class="form-buttons" style="margin-top: 1rem;">
                        <button onclick="closePopup()" type="button">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

    } catch (error) {
        console.error('Dashboard initialization error:', error);
        window.location.href = '/login';
    }
});

       function showInitialPopup() {
            const popup = document.querySelector('.popup');
            popup.innerHTML = `
                <div class="popup-content">
                    <h2>Welcome!</h2>
                    <p>Let's get started by adding what you need or what you can donate.</p>
                    <div class="popup-buttons">
                        <button onclick="addNeeds()">Add Needs</button>
                        <button onclick="addDonations()">Add Donations</button>
                    </div>
                    <div class="form-buttons" style="margin-top: 1rem;">
                        <button onclick="closePopup()" type="button">Cancel</button>
                    </div>
                </div>
            `;
}

        function addNeeds() {
            const popup = document.querySelector('.popup');
            popup.innerHTML = `
                <div class="popup-content form-popup">
                    <h2>Add What You Need</h2>
                    <form id="needsForm">
                        <div id="needsContainer">
                            <div class="needs-row">
                                <div class="input-group">
                                    <label for="itemName_0">Item</label>
                                    <input type="text" id="itemName_0" required>
                                </div>
                                <div class="input-group">
                                    <label for="quantity_0">Quantity</label>
                                    <input type="number" id="quantity_0" min="1" placeholder="Optional">
                                </div>
                                <div class="input-group urgency-group">
                                    <label>Urgency</label>
                                    <div class="urgency-selector" id="urgency_0">
                                        <div class="urgency-segment low-urgency" data-urgency="low" onclick="selectUrgency(this)">Low</div>
                                        <div class="urgency-segment medium-urgency" data-urgency="medium" onclick="selectUrgency(this)">Medium</div>
                                        <div class="urgency-segment high-urgency" data-urgency="high" onclick="selectUrgency(this)">High</div>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="notes_0">Notes</label>
                                    <input type="text" id="notes_0">
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="addNeedRow()" class="add-row-btn">+ Add Another Item</button>
                        <div class="form-buttons">
                            <button type="submit">Submit</button>
                            <button type="button" onclick="showInitialPopup()">Back</button>
                        </div>
                    </form>
                </div>
            `;
            setTimeout(initializeItemDropdowns, 0);
            // Add global function for urgency selection
            window.selectUrgency = function(element) {
                const parent = element.closest('.urgency-selector');
                // Remove active class from all segments
                parent.querySelectorAll('.urgency-segment').forEach(segment => {
                    segment.classList.remove('active');
                });
                // Add active class to clicked segment
                element.classList.add('active');
            };

            let rowCount = 1;

            window.addNeedRow = function() {
                const container = document.getElementById('needsContainer');
                const newRow = document.createElement('div');
                newRow.className = 'needs-row';
                newRow.innerHTML = `
                    <div class="input-group">
                        <label for="itemName_${rowCount}">Item</label>
                        <input type="text" id="itemName_${rowCount}" required>
                    </div>
                    <div class="input-group">
                        <label for="quantity_${rowCount}">Quantity</label>
                        <input type="number" id="quantity_${rowCount}" min="1" placeholder="Optional">
                    </div>
                    <div class="input-group urgency-group">
                        <label>Urgency</label>
                        <div class="urgency-selector" id="urgency_${rowCount}">
                            <div class="urgency-segment low-urgency" data-urgency="low" onclick="selectUrgency(this)">Low</div>
                            <div class="urgency-segment medium-urgency" data-urgency="medium" onclick="selectUrgency(this)">Medium</div>
                            <div class="urgency-segment high-urgency" data-urgency="high" onclick="selectUrgency(this)">High</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="notes_${rowCount}">Notes</label>
                        <input type="text" id="notes_${rowCount}">
                    </div>
                    <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">×</button>
                `;
                setTimeout(initializeItemDropdowns, 0);
                container.appendChild(newRow);
                rowCount++;
            };
            

            document.getElementById('needsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateItemInputs('needsForm')) return;
                try {
                    const user = firebase.auth().currentUser;
                    const needItems = [];

                    const rows = document.querySelectorAll('.needs-row');
                    rows.forEach((row, index) => {
                        const quantity = document.getElementById(`quantity_${index}`).value;
                        const urgencySelector = document.getElementById(`urgency_${index}`);
                        const activeUrgency = urgencySelector.querySelector('.active');
                        
                        needItems.push({
                            itemName: document.getElementById(`itemName_${index}`).value,
                            quantity: quantity ? parseInt(quantity) : null,
                            urgency: activeUrgency ? activeUrgency.dataset.urgency : 'low',
                            notes: document.getElementById(`notes_${index}`).value,
                            timestamp: new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })
                        });
                    });

                    const userRef = firebase.firestore().collection('users').doc(user.uid);
                    await userRef.update({
                        needs: firebase.firestore.FieldValue.arrayUnion(...needItems)
                    });
                    showInitialPopup();
                } catch (error) {
                    console.error('Error adding needs:', error);
                    alert('Error adding needs. Please try again.');
                }
            });
        }

       function addDonations() {
           const popup = document.querySelector('.popup');
           popup.innerHTML = `
               <div class="popup-content form-popup">
                   <h2>Add What You Can Donate</h2>
                   <form id="donateForm">
                       <div id="donationsContainer">
                           <div class="needs-row">
                               <div class="input-group">
                                   <label for="itemName_0">Item</label>
                                   <input type="text" id="itemName_0" required>
                               </div>
                               <div class="input-group">
                                   <label for="quantity_0">Quantity</label>
                                   <input type="number" id="quantity_0" min="1" placeholder="Optional">
                               </div>
                               <div class="input-group">
                                   <label for="notes_0">Notes</label>
                                   <input type="text" id="notes_0">
                               </div>
                           </div>
                       </div>
                       <button type="button" onclick="addDonationRow()" class="add-row-btn">+ Add Another Item</button>
                       <div class="form-buttons">
                            <button type="submit">Submit</button>
                            <button type="button" onclick="showInitialPopup()">Back</button>
                        </div>
                   </form>
               </div>
           `;

           setTimeout(initializeItemDropdowns, 0);
           let rowCount = 1;

           window.addDonationRow = function() {
               const container = document.getElementById('donationsContainer');
               const newRow = document.createElement('div');
               newRow.className = 'needs-row';
               newRow.innerHTML = `
                   <div class="input-group">
                       <label for="itemName_${rowCount}">Item</label>
                       <input type="text" id="itemName_${rowCount}" required>
                   </div>
                   <div class="input-group">
                       <label for="quantity_${rowCount}">Quantity</label>
                       <input type="number" id="quantity_${rowCount}" min="1" placeholder="Optional">
                   </div>
                   <div class="input-group">
                       <label for="notes_${rowCount}">Notes</label>
                       <input type="text" id="notes_${rowCount}">
                   </div>
                   <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">×</button>
               `;
               setTimeout(initializeItemDropdowns, 0);
               container.appendChild(newRow);
               rowCount++;
           };

           document.getElementById('donateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = firebase.auth().currentUser;
                const donationItems = [];

                const rows = document.querySelectorAll('.needs-row');
                rows.forEach((row, index) => {
                    const quantity = document.getElementById(`quantity_${index}`).value;
                    donationItems.push({
                        itemName: document.getElementById(`itemName_${index}`).value,
                        quantity: quantity ? parseInt(quantity) : null,
                        notes: document.getElementById(`notes_${index}`).value,
                        timestamp: new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })
                    });
                });

                const userRef = firebase.firestore().collection('users').doc(user.uid);
                await userRef.update({
                    canDonate: firebase.firestore.FieldValue.arrayUnion(...donationItems)
                });
                showInitialPopup();  // Changed this line from closePopup()
            } catch (error) {
                console.error('Error adding donations:', error);
                alert('Error adding donations. Please try again.');
            }
        });
       }

       function highlightMatchingItems(userData, centerData) {
    // Ensure we're running after DOM is fully updated
    setTimeout(() => {
        console.log('Highlighting matching items');
        console.log('userData:', userData);
        console.log('centerData:', centerData);

        // Default to empty arrays if needed
        const userNeeds = userData?.needs || [];
        const userDonateItems = userData?.canDonate || [];

        // Use multiple selectors to find items
        const inventorySelectors = [
            '.matches-section.matches-needs .match-item',
            '.matches-needs .match-item',
            '.center-card .match-item'
        ];

        const needSelectors = [
            '.matches-section.matches-donations .match-item',
            '.matches-donations .match-item',
            '.center-card .match-item'
        ];

        // Function to find first matching elements
        function findElements(selectors) {
            for (let selector of selectors) {
                const elements = document.querySelectorAll(selector);
                if (elements.length > 0) {
                    console.log(`Found elements with selector: ${selector}`, elements);
                    return elements;
                }
            }
            console.log('No elements found with any selector');
            return [];
        }

        const inventoryItems = findElements(inventorySelectors);
        const needItems = findElements(needSelectors);

        console.log('Inventory Items:', inventoryItems);
        console.log('Need Items:', needItems);

        // Highlight inventory items that match user needs
        inventoryItems.forEach(inventoryItem => {
            const inventoryName = inventoryItem.textContent.trim().toLowerCase();
            
            const match = userNeeds.some(userNeed => {
                const needName = userNeed?.itemName?.toLowerCase() || '';
                return needName === inventoryName;
            });

            console.log(`Inventory item ${inventoryName} match:`, match);

            if (match) {
                inventoryItem.classList.add('highlight-match');
            }
        });

        // Highlight need items that match user donations
        needItems.forEach(needItem => {
            const needName = needItem.textContent.trim().toLowerCase();
            
            const match = userDonateItems.some(userItem => {
                const donationName = userItem?.itemName?.toLowerCase() || '';
                return donationName === needName;
            });

            console.log(`Need item ${needName} match:`, match);

            if (match) {
                needItem.classList.add('highlight-match');
            }
        });
    }, 100); // Short delay to ensure DOM is updated
}
       function closePopup() {
           const popup = document.querySelector('.popup');
           if (popup) {
               popup.remove();
           }
       }

       async function goToProfile(event) {
            event.preventDefault();
            const user = firebase.auth().currentUser;
            if (user) {
                const token = await user.getIdToken();
                const url = new URL('/neighbor-profile', window.location.origin);
                url.searchParams.append('token', token);
                window.location.href = url.toString();
            }
        }
   </script>
</body>
</html>