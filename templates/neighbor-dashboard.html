<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neighbor Dashboard</title>
    <link rel="stylesheet" href="/static/css/neighborDash.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">Help626</div>
        <div class="nav-links">
            <a href="#" id="userEmail" onclick="goToProfile(event)"></a>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>              
    </nav>

    <div class="dashboard-container">
        <div class="filter-section">
            <select id="radiusFilter" onchange="updateDonationCenters(userData)">
                <option value="5">Within 5 miles</option>
                <option value="10">Within 10 miles</option>
                <option value="25">Within 25 miles</option>
                <option value="50">Within 50 miles</option>
                <option value="999">Any distance</option>
            </select>
        </div>

        <div id="donationCentersList" class="centers-list">
            <!-- Centers will be loaded here dynamically -->
        </div>
    </div>

   <!-- Firebase SDKs -->
   <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

   <!-- Firebase Config -->
   <script src="{{ url_for('static', filename='js/config.js') }}"></script>

   <!-- Auth -->
   <script src="{{ url_for('static', filename='js/auth.js') }}"></script>

   <script>
let userLocation = null;

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 3959; // Earth's radius in miles
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function toRad(degrees) {
    return degrees * (Math.PI/180);
}

async function updateDonationCenters(userData) {
    const radius = parseFloat(document.getElementById('radiusFilter').value);
    
    try {
        const centersSnapshot = await firebase.firestore()
            .collection('users')
            .where('isDonationCenter', '==', true)
            .get();

        const centersList = document.getElementById('donationCentersList');
        centersList.innerHTML = '';

        centersSnapshot.forEach(doc => {
            const centerData = doc.data();
            
            if (!centerData.location) return;

            const distance = calculateDistance(
                userLocation.latitude,
                userLocation.longitude,
                centerData.location.latitude,
                centerData.location.longitude
            );

            if (distance <= radius || radius === 999) {
                const centerCard = document.createElement('div');
                centerCard.className = 'center-card';
                centerCard.innerHTML = `
                    <div class="center-info">
                        <h3>${centerData.centerName || 'Unnamed Center'}</h3>
                        <p class="distance">${distance.toFixed(1)} miles away</p>
                        ${centerData.needs && centerData.needs.length > 0 ? `
                        ` : '<p>No current needs listed</p>'}
                    </div>
                    <div class="matches-container">
                        <div class="matches-section matches-needs">
                            <h4>Items They Have That You Need</h4>
                            <ul>
                                ${findMatches(userData?.needs || [], centerData?.inventory || []).map(match => `
                                    <li>
                                        <span class="match-item">${match.itemName}</span>
                                        ${match.quantity ? `<span class="match-quantity">(${match.quantity} available)</span>` : ''}
                                    </li>
                                `).join('') || '<li class="no-matches">No matching items</li>'}
                            </ul>
                        </div>
                        <div class="matches-section matches-donations">
                            <h4>Items You Can Donate That They Need</h4>
                            <ul>
                                ${findMatches(userData?.canDonate || [], centerData?.needs || []).map(match => `
                                    <li>
                                        <span class="match-item">${match.itemName}</span>
                                        ${match.quantity ? `<span class="match-quantity">(${match.quantity} needed)</span>` : ''}
                                        ${match.urgency ? `<span class="urgency-tag ${match.urgency}-urgency">${match.urgency}</span>` : ''}
                                    </li>
                                `).join('') || '<li class="no-matches">No matching items</li>'}
                            </ul>
                        </div>
                    </div>
                `;
                centersList.appendChild(centerCard);
            }
        });

        if (centersList.children.length === 0) {
            centersList.innerHTML = `
                <div class="no-centers">
                    No donation centers found within ${radius} miles
                </div>
            `;
        }

    } catch (error) {
        console.error('Error fetching donation centers:', error);
    }
}

// Updated findMatches function with better null checks
function findMatches(userItems = [], centerItems = []) {
    if (!Array.isArray(userItems) || !Array.isArray(centerItems)) return [];
    
    return userItems.filter(userItem => 
        centerItems.some(centerItem => 
            userItem?.itemName?.toLowerCase() === centerItem?.itemName?.toLowerCase()
        )
    ).map(userItem => {
        const centerItem = centerItems.find(item => 
            item?.itemName?.toLowerCase() === userItem?.itemName?.toLowerCase()
        );
        return {
            ...centerItem,
            quantity: centerItem?.quantity || userItem?.quantity,
            itemName: userItem?.itemName || 'Unnamed Item'
        };
    });
}
function viewCenter(centerId) {
    // Implement center details view
    console.log('Viewing center:', centerId);
}

       document.addEventListener('DOMContentLoaded', async () => {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            console.log('No token found in URL');
            window.location.href = '/login';
            return;
        }

        await new Promise((resolve) => {
            const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                unsubscribe();
                resolve(user);
            });
        });

        const user = firebase.auth().currentUser;
        if (!user) {
            console.log('No user found');
            window.location.href = '/login';
            return;
        }

        const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
        const userData = userDoc.data();

        document.getElementById('userEmail').textContent = user.email;

        // Check and store user location
        userLocation = userData.location;
        if (!userLocation) {
            window.location.href = '/setup-location';
            return;
        }

        // Initialize centers list
        updateDonationCenters(userData);

        document.getElementById('radiusFilter').addEventListener('change', () => {
            updateDonationCenters(userData);  // Pass userData here too
        });

        // Show welcome popup if needed
        if ((!userData.canDonate || userData.canDonate.length === 0) && 
            (!userData.needs || userData.needs.length === 0)) {
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h2>Welcome!</h2>
                    <p>Let's get started by adding what you need or what you can donate.</p>
                    <div class="popup-buttons">
                        <button onclick="addNeeds()">Add Needs</button>
                        <button onclick="addDonations()">Add Donations</button>
                    </div>
                    <div class="form-buttons" style="margin-top: 1rem;">
                        <button onclick="closePopup()" type="button">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

    } catch (error) {
        console.error('Dashboard initialization error:', error);
        window.location.href = '/login';
    }
});

       function showInitialPopup() {
            const popup = document.querySelector('.popup');
            popup.innerHTML = `
                <div class="popup-content">
                    <h2>Welcome!</h2>
                    <p>Let's get started by adding what you need or what you can donate.</p>
                    <div class="popup-buttons">
                        <button onclick="addNeeds()">Add Needs</button>
                        <button onclick="addDonations()">Add Donations</button>
                    </div>
                    <div class="form-buttons" style="margin-top: 1rem;">
                        <button onclick="closePopup()" type="button">Cancel</button>
                    </div>
                </div>
            `;
}

        function addNeeds() {
            const popup = document.querySelector('.popup');
            popup.innerHTML = `
                <div class="popup-content form-popup">
                    <h2>Add What You Need</h2>
                    <form id="needsForm">
                        <div id="needsContainer">
                            <div class="needs-row">
                                <div class="input-group">
                                    <label for="itemName_0">Item</label>
                                    <input type="text" id="itemName_0" required>
                                </div>
                                <div class="input-group">
                                    <label for="quantity_0">Quantity</label>
                                    <input type="number" id="quantity_0" min="1" placeholder="Optional">
                                </div>
                                <div class="input-group urgency-group">
                                    <label>Urgency</label>
                                    <div class="urgency-selector" id="urgency_0">
                                        <div class="urgency-segment low-urgency" data-urgency="low" onclick="selectUrgency(this)">Low</div>
                                        <div class="urgency-segment medium-urgency" data-urgency="medium" onclick="selectUrgency(this)">Medium</div>
                                        <div class="urgency-segment high-urgency" data-urgency="high" onclick="selectUrgency(this)">High</div>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="notes_0">Notes</label>
                                    <input type="text" id="notes_0">
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="addNeedRow()" class="add-row-btn">+ Add Another Item</button>
                        <div class="form-buttons">
                            <button type="submit">Submit</button>
                            <button type="button" onclick="showInitialPopup()">Back</button>
                        </div>
                    </form>
                </div>
            `;

            // Add global function for urgency selection
            window.selectUrgency = function(element) {
                const parent = element.closest('.urgency-selector');
                // Remove active class from all segments
                parent.querySelectorAll('.urgency-segment').forEach(segment => {
                    segment.classList.remove('active');
                });
                // Add active class to clicked segment
                element.classList.add('active');
            };

            let rowCount = 1;

            window.addNeedRow = function() {
                const container = document.getElementById('needsContainer');
                const newRow = document.createElement('div');
                newRow.className = 'needs-row';
                newRow.innerHTML = `
                    <div class="input-group">
                        <label for="itemName_${rowCount}">Item</label>
                        <input type="text" id="itemName_${rowCount}" required>
                    </div>
                    <div class="input-group">
                        <label for="quantity_${rowCount}">Quantity</label>
                        <input type="number" id="quantity_${rowCount}" min="1" placeholder="Optional">
                    </div>
                    <div class="input-group urgency-group">
                        <label>Urgency</label>
                        <div class="urgency-selector" id="urgency_${rowCount}">
                            <div class="urgency-segment low-urgency" data-urgency="low" onclick="selectUrgency(this)">Low</div>
                            <div class="urgency-segment medium-urgency" data-urgency="medium" onclick="selectUrgency(this)">Medium</div>
                            <div class="urgency-segment high-urgency" data-urgency="high" onclick="selectUrgency(this)">High</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="notes_${rowCount}">Notes</label>
                        <input type="text" id="notes_${rowCount}">
                    </div>
                    <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">×</button>
                `;
                container.appendChild(newRow);
                rowCount++;
            };

            document.getElementById('needsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const user = firebase.auth().currentUser;
                    const needItems = [];

                    const rows = document.querySelectorAll('.needs-row');
                    rows.forEach((row, index) => {
                        const quantity = document.getElementById(`quantity_${index}`).value;
                        const urgencySelector = document.getElementById(`urgency_${index}`);
                        const activeUrgency = urgencySelector.querySelector('.active');
                        
                        needItems.push({
                            itemName: document.getElementById(`itemName_${index}`).value,
                            quantity: quantity ? parseInt(quantity) : null,
                            urgency: activeUrgency ? activeUrgency.dataset.urgency : 'low',
                            notes: document.getElementById(`notes_${index}`).value,
                            timestamp: new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })
                        });
                    });

                    const userRef = firebase.firestore().collection('users').doc(user.uid);
                    await userRef.update({
                        needs: firebase.firestore.FieldValue.arrayUnion(...needItems)
                    });
                    showInitialPopup();
                } catch (error) {
                    console.error('Error adding needs:', error);
                    alert('Error adding needs. Please try again.');
                }
            });
        }

       function addDonations() {
           const popup = document.querySelector('.popup');
           popup.innerHTML = `
               <div class="popup-content form-popup">
                   <h2>Add What You Can Donate</h2>
                   <form id="donateForm">
                       <div id="donationsContainer">
                           <div class="needs-row">
                               <div class="input-group">
                                   <label for="itemName_0">Item</label>
                                   <input type="text" id="itemName_0" required>
                               </div>
                               <div class="input-group">
                                   <label for="quantity_0">Quantity</label>
                                   <input type="number" id="quantity_0" min="1" placeholder="Optional">
                               </div>
                               <div class="input-group">
                                   <label for="notes_0">Notes</label>
                                   <input type="text" id="notes_0">
                               </div>
                           </div>
                       </div>
                       <button type="button" onclick="addDonationRow()" class="add-row-btn">+ Add Another Item</button>
                       <div class="form-buttons">
                            <button type="submit">Submit</button>
                            <button type="button" onclick="showInitialPopup()">Back</button>
                        </div>
                   </form>
               </div>
           `;

           let rowCount = 1;

           window.addDonationRow = function() {
               const container = document.getElementById('donationsContainer');
               const newRow = document.createElement('div');
               newRow.className = 'needs-row';
               newRow.innerHTML = `
                   <div class="input-group">
                       <label for="itemName_${rowCount}">Item</label>
                       <input type="text" id="itemName_${rowCount}" required>
                   </div>
                   <div class="input-group">
                       <label for="quantity_${rowCount}">Quantity</label>
                       <input type="number" id="quantity_${rowCount}" min="1" placeholder="Optional">
                   </div>
                   <div class="input-group">
                       <label for="notes_${rowCount}">Notes</label>
                       <input type="text" id="notes_${rowCount}">
                   </div>
                   <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">×</button>
               `;
               container.appendChild(newRow);
               rowCount++;
           };

           document.getElementById('donateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = firebase.auth().currentUser;
                const donationItems = [];

                const rows = document.querySelectorAll('.needs-row');
                rows.forEach((row, index) => {
                    const quantity = document.getElementById(`quantity_${index}`).value;
                    donationItems.push({
                        itemName: document.getElementById(`itemName_${index}`).value,
                        quantity: quantity ? parseInt(quantity) : null,
                        notes: document.getElementById(`notes_${index}`).value,
                        timestamp: new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })
                    });
                });

                const userRef = firebase.firestore().collection('users').doc(user.uid);
                await userRef.update({
                    canDonate: firebase.firestore.FieldValue.arrayUnion(...donationItems)
                });
                showInitialPopup();  // Changed this line from closePopup()
            } catch (error) {
                console.error('Error adding donations:', error);
                alert('Error adding donations. Please try again.');
            }
        });
       }

       function closePopup() {
           const popup = document.querySelector('.popup');
           if (popup) {
               popup.remove();
           }
       }

       async function goToProfile(event) {
            event.preventDefault();
            const user = firebase.auth().currentUser;
            if (user) {
                const token = await user.getIdToken();
                const url = new URL('/neighbor-profile', window.location.origin);
                url.searchParams.append('token', token);
                window.location.href = url.toString();
            }
        }
   </script>
</body>
</html>