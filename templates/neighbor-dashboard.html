<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MWCEE8FEXB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MWCEE8FEXB');
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.png">
    <title>Neighbor Dashboard</title>
    <link rel="stylesheet" href="/static/css/neighborDash.css">
    <link rel="stylesheet" href="/static/css/item-dropdown-styles.css">
    <link rel="stylesheet" href="/static/css/navBar.css">
    <script src="/static/js/item-searchable-dropdown.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <img src="static\images\Logo.png" alt="Logo" class="nav-logo">
        </div>
        <div class="nav-links">
            <a href="#" id="userEmail" onclick="goToProfile(event)"></a>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>              
    </nav>

    <div id="bannerContainer"></div>


    <div class="emergency-banner">
        <div class="emergency-content">
            <span class="emergency-dot">‚óè</span>
            <span class="emergency-text">Live Updates About the Fires From LAFD</span>
            <a href="#" class="emergency-link" onclick="openUpdatesPopup(event)">View Updates</a>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="filter-section">
            <div class="filter-header">
                <div class="icon-container">
                    <svg class="location-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
                <div class="header-text">
                    <h3 class="header-title">Nearby Centers</h3>
                    <p class="header-subtitle" id="centersCount">0 centers within 5 miles</p>
                </div>
            </div>
            <select id="radiusFilter" onchange="updateDonationCenters(userData)">
                <option value="5">Within 5 miles</option>
                <option value="10">Within 10 miles</option>
                <option value="25">Within 25 miles</option>
                <option value="50">Within 50 miles</option>
                <option value="999">Any distance</option>
            </select>
        </div>

        <div id="donationCentersList" class="centers-list">
            <!-- Centers will be loaded here dynamically -->
        </div>
    </div>

   <!-- Firebase SDKs -->
   <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

   <!-- Firebase Config -->
   <script src="{{ url_for('static', filename='js/config.js') }}"></script>

   <!-- Auth -->
   <script src="{{ url_for('static', filename='js/auth.js') }}"></script>

   <script>
let userLocation = null;

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 3959; // Earth's radius in miles
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function reorderCenterDivs() {
    const centersList = document.getElementById('donationCentersList');
    
    // Convert center cards to an array and sort
    const centerCards = Array.from(centersList.querySelectorAll('.center-card'));
    
    const sortedCards = centerCards.sort((a, b) => {
        // Extract distance from .distance element
        const distanceA = parseFloat(a.querySelector('.distance').textContent);
        const distanceB = parseFloat(b.querySelector('.distance').textContent);
        
        return distanceA - distanceB;
    });

    // Clear existing centers
    centersList.innerHTML = '';

    // Reappend sorted cards
    sortedCards.forEach(card => centersList.appendChild(card));
}

function toRad(degrees) {
    return degrees * (Math.PI/180);
}

function convertTo12HourFormat(time) {
    if (!time) return '';
    let [hour, minute] = time.split(':');
    hour = parseInt(hour);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    hour = hour % 12;
    hour = hour ? hour : 12; // the hour '0' should be '12'
    minute = minute.padStart(2, '0');
    return `${hour}:${minute} ${ampm}`;
}

function generateHoursHTML(hours, centerId) {
    if (!hours) return '';
    
    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const currentDay = days[new Date().getDay()];
    const currentDate = new Date();
    
    // Check if any days have hours set
    const hasAnyHours = days.some(day => {
        const dayHours = hours[day];
        return dayHours && dayHours.open && dayHours.close;
    });

    // If no days have hours set, don't return any hours display
    if (!hasAnyHours) {
        return '';
    }

    const todayHours = hours[currentDay];
    let statusText = 'Closed';

    if (todayHours && todayHours.open && todayHours.close) {
        const [openHour, openMinute] = todayHours.open.split(':').map(Number);
        const [closeHour, closeMinute] = todayHours.close.split(':').map(Number);
        const openTime = new Date();
        openTime.setHours(openHour, openMinute, 0);
        const closeTime = new Date();
        closeTime.setHours(closeHour, closeMinute, 0);

        // Handle cases where closing time is past midnight
        if (closeTime < openTime) {
            closeTime.setDate(closeTime.getDate() + 1);
        }

        if (currentDate >= openTime && currentDate <= closeTime) {
            statusText = `Open until ${convertTo12HourFormat(todayHours.close)}`;
        }
    }
    
    // If not currently open, always check future days for next opening
    if (statusText === 'Closed') {
        // Find the next open day
        let foundOpenDay = false;
        
        // Check today (if there are hours) and up to 7 days ahead
        for (let i = 0; i < 7; i++) {
            const checkIndex = (days.indexOf(currentDay) + i) % 7;
            const checkDay = days[checkIndex];
            const dayHours = hours[checkDay];
            
            if (dayHours && dayHours.open) {
                const [nextOpenHour, nextOpenMinute] = dayHours.open.split(':').map(Number);
                const nextOpenTime = new Date();
                nextOpenTime.setHours(nextOpenHour, nextOpenMinute, 0);
                
                if (i === 0) {
                    // Today: only show if the opening time hasn't passed
                    if (currentDate < nextOpenTime) {
                        statusText = `Closed until ${convertTo12HourFormat(dayHours.open)}`;
                        foundOpenDay = true;
                        break;
                    }
                } else {
                    // Future days
                    if (i === 1) {
                        statusText = `Closed until ${convertTo12HourFormat(dayHours.open)} tomorrow`;
                    } else {
                        const dayName = checkDay.charAt(0).toUpperCase() + checkDay.slice(1);
                        statusText = `Closed until ${convertTo12HourFormat(dayHours.open)} ${dayName}`;
                    }
                    foundOpenDay = true;
                    break;
                }
            }
        }
    }

    const popupContent = days.map(day => {
        const dayHours = hours[day];
        if (dayHours?.open && dayHours?.close) {
            return `<div class="day-hours">
                ${day.charAt(0).toUpperCase() + day.slice(1)}: 
                ${convertTo12HourFormat(dayHours.open)} - ${convertTo12HourFormat(dayHours.close)}
            </div>`;
        }
        return `<div class="day-hours">${day.charAt(0).toUpperCase() + day.slice(1)}: Closed</div>`;
    }).join('');

    const statusClass = statusText.toLowerCase().includes('open') ? 'hours-status-open' : 'hours-status-closed';

    return `
    <div class="center-hours">
        <h4 class="${statusClass}">${statusText}</h4>
        <div class="hours-popup">
            <div class="hours-content">
                ${popupContent}
            </div>
        </div>
    </div>
`;
}

async function updateDonationCenters(userData) {
    
    console.log('Starting updateDonationCenters');
    const radius = parseFloat(document.getElementById('radiusFilter').value);
    
    try {
        const centersSnapshot = await firebase.firestore()
            .collection('users')
            .where('isDonationCenter', '==', true)
            .get();

        const centersList = document.getElementById('donationCentersList');
        centersList.innerHTML = '';

        let centersCount = 0;

        centersSnapshot.forEach(doc => {
            const centerData = doc.data();
            
            console.log('Full center data:', centerData);
            console.log('Operating Hours:', centerData.operatingHours);
            
            if (!centerData.location) return;

            const distance = calculateDistance(
                userLocation.latitude,
                userLocation.longitude,
                centerData.location.latitude,
                centerData.location.longitude
            );

            if (distance <= radius || radius === 999) {
                centersCount++;
                const centerCard = document.createElement('div');
                centerCard.className = 'center-card';
                
                const hasAddress = centerData.addressInfo && centerData.addressInfo.street != null;

            centerCard.innerHTML = `
                <div class="center-header">
                    <div class="center-main-info">
                        <h3>${centerData.centerName || 'Unnamed Center'}</h3>
                            ${centerData.contactInfo?.phone ? 
                                `<p class="contact-detail">
                                    <svg class="phone-icon" style="transform: translateY(2px)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                    </svg>
                                    ${centerData.contactInfo.phone}
                                </p>` : ''}
                            ${centerData.contactInfo?.email ? 
                                `<p class="contact-detail">
                                    <svg class="email-icon" style="transform: translateY(4px)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                        <polyline points="22,6 12,13 2,6"></polyline>
                                    </svg>
                                    ${centerData.contactInfo.email}
                                </p>` : ''}
                        </div>
                    <div class="center-location">
                        <div class="location-info">
                ${hasAddress ? `
                    <div class="address-wrapper" style="display: flex;">    
                        <svg class="pin-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span>${[
                            centerData.addressInfo.street,
                            centerData.addressInfo.unit ? `Unit ${centerData.addressInfo.unit}` : null,
                            centerData.addressInfo.city,
                            centerData.addressInfo.zipCode
                        ].filter(Boolean).join(', ')}</span>
                    </div>
                    <span class="dot-separator" style="display: block;"></span>
                ` : ''}
                <span class="distance">${distance.toFixed(1)} miles away</span>
            </div>
            ${generateHoursHTML(centerData.operatingHours, doc.id)}
        </div>
    </div>

    ${centerData.centerNotes ? `
        <div class="additional-info">
            <h4>Notes</h4>
            <p>${centerData.centerNotes}</p>
        </div>
    ` : ''}

    <div class="matches-container">
        <div class="matches-section matches-inventory">
            <h4><svg class="svg-icon box-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                <polyline points="3.29 7 12 12 20.71 7"/>
                                <line x1="12" y1="22" x2="12" y2="12"/>
                            </svg>
                                <span>Center's Inventory</span>
                                </h4>
            <ul>
                ${centerData?.inventory?.length > 0 ? 
                    centerData.inventory.map(item => `
                        <li>
                            <span class="match-item">${item.itemName || 'Unnamed Item'}</span>
                            ${item.quantity ? `<span class="match-quantity">(${item.quantity} available)</span>` : ''}
                        </li>
                    `).join('') : '<li class="no-matches">Center currently hasn\'t set up inventory</li>'
                }
            </ul>
        </div>
        <div class="matches-section matches-needs">
            <h4> <svg class="svg-icon heart-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                <path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0 5.4 5.4 0 0 0 0 7.65l.77.78 7.65 7.65 7.65-7.65.77-.78a5.4 5.4 0 0 0 0-7.65z"/>
                            </svg>
                                <span>Center's Needs</span>
                            </h4>
            <ul>
                ${centerData?.needs?.length > 0 ? 
                    centerData.needs.map(need => `
                        <li>
                            <span class="match-item">${need.itemName}</span>
                            ${need.quantity ? `<span class="match-quantity">(${need.quantity} needed)</span>` : ''}
                            ${need.urgency ? `<span class="urgency-tag ${need.urgency}-urgency">${need.urgency} urgency</span>` : ''}
                        </li>
                    `).join('') : '<li class="no-matches">Center currently hasn\'t set up needs</li>'
                }
            </ul>
        </div>
    </div>
`;
                highlightMatchingItems(userData, centerData);
                
                centersList.appendChild(centerCard);
            }
        });

        reorderCenterDivs();

        const countText = radius === 999 
            ? `${centersCount} centers found` 
            : `${centersCount} centers within ${radius} miles`;

        document.getElementById('centersCount').textContent = countText;

        if (centersList.children.length === 0) {
            centersList.innerHTML = `
                <div class="no-centers">
                    No donation centers found within ${radius} miles
                </div>
            `;
        }

    } catch (error) {
        console.error('Error fetching donation centers:', error);
    }
}

// New inline hours update function

function updateCenterHoursInline(operatingHours, hoursId) {
    console.log('Updating hours inline for hoursId:', hoursId);
    
    // Find status and hours elements using specific selectors
    const statusEl = document.getElementById(`${hoursId}-status`);
    const hoursEl = document.getElementById(`${hoursId}-hours`);

    // Validate elements exist
    if (!statusEl || !hoursEl) {
        console.error('Could not find status or hours elements', {
            hoursId: hoursId,
            statusEl: !!statusEl,
            hoursEl: !!hoursEl,
            statusElExists: document.getElementById(`${hoursId}-status`) !== null,
            hoursElExists: document.getElementById(`${hoursId}-hours`) !== null
        });
        return;
    }

    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const currentDay = days[new Date().getDay()];
    const currentDate = new Date();
    
    // Use the exact field names from your Firebase structure
    const todayHours = operatingHours[currentDay];

    let hoursStatus = 'Closed';

    if (todayHours && todayHours.open && todayHours.close) {
        const [openHour, openMinute] = todayHours.open.split(':').map(Number);
        const [closeHour, closeMinute] = todayHours.close.split(':').map(Number);
        
        const openTime = new Date();
        openTime.setHours(openHour, openMinute, 0);
        
        const closeTime = new Date();
        closeTime.setHours(closeHour, closeMinute, 0);

        // Handle cases where closing time is past midnight
        if (closeTime < openTime) {
            closeTime.setDate(closeTime.getDate() + 1);
        }

        if (currentDate >= openTime && currentDate <= closeTime) {
            hoursStatus = `Open until ${convertTo12HourFormat(todayHours.close)}`;
        } else {
            // Find the next open day
            let foundOpenDay = false;
            
            // Check up to 7 days ahead
            for (let i = 0; i < 7; i++) {
                const checkIndex = (days.indexOf(currentDay) + i) % 7;
                const checkDay = days[checkIndex];
                const dayHours = operatingHours[checkDay];
                
                if (dayHours && dayHours.open) {
                    const [nextOpenHour, nextOpenMinute] = dayHours.open.split(':').map(Number);
                    const nextOpenTime = new Date();
                    
                    nextOpenTime.setHours(nextOpenHour, nextOpenMinute, 0);
                    
                    if (i === 0) {
                        // Today: only show if the opening time hasn't passed
                        if (currentDate < nextOpenTime) {
                            hoursStatus = `Closed until ${convertTo12HourFormat(dayHours.open)}`;
                            foundOpenDay = true;
                            break;
                        }
                    } else {
                        // Future days
                        nextOpenTime.setDate(nextOpenTime.getDate() + i);
                        if (i === 1) {
                            hoursStatus = `Closed until ${convertTo12HourFormat(dayHours.open)} tomorrow`;
                        } else {
                            const dayName = checkDay.charAt(0).toUpperCase() + checkDay.slice(1);
                            hoursStatus = `Closed until ${convertTo12HourFormat(dayHours.open)} ${dayName}`;
                        }
                        foundOpenDay = true;
                        break;
                    }
                }
            }
            
            if (!foundOpenDay) {
                hoursStatus = 'Closed';
            }
        }
    }

    // Update status
    statusEl.textContent = hoursStatus;

    // Populate full hours
    const fullHoursHTML = days.map(day => {
        const dayHours = operatingHours[day];
        if (dayHours?.open && dayHours?.close) {
            return `<div class="day-hours ${day === currentDay ? 'current-day' : ''}">
                ${day.charAt(0).toUpperCase() + day.slice(1)}: 
                ${convertTo12HourFormat(dayHours.open)} - ${convertTo12HourFormat(dayHours.close)}
            </div>`;
        }
        return `<div class="day-hours">${day.charAt(0).toUpperCase() + day.slice(1)}: Closed</div>`;
    }).join('');

    hoursEl.innerHTML = fullHoursHTML;
}


// Updated findMatches function with better null checks
function findMatches(userItems = [], centerItems = []) {
    if (!Array.isArray(userItems) || !Array.isArray(centerItems)) return [];
    
    return userItems.filter(userItem => 
        centerItems.some(centerItem => 
            userItem?.itemName?.toLowerCase() === centerItem?.itemName?.toLowerCase()
        )
    ).map(userItem => {
        const centerItem = centerItems.find(item => 
            item?.itemName?.toLowerCase() === userItem?.itemName?.toLowerCase()
        );
        return {
            ...centerItem,
            quantity: centerItem?.quantity || userItem?.quantity,
            itemName: userItem?.itemName || 'Unnamed Item'
        };
    });
}
function viewCenter(centerId) {
    // Implement center details view
    console.log('Viewing center:', centerId);
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Clear banner container initially
        const bannerContainer = document.getElementById('bannerContainer');
        if (bannerContainer) {
            bannerContainer.innerHTML = '';
        }

        // Remove existing help banner if any
        localStorage.removeItem('helpBannerClosed');
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            console.log('No token found in URL');
            window.location.href = '/landing-page';
            return;
        }

        // Wait for Firebase auth
        await new Promise((resolve) => {
            const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                unsubscribe();
                resolve(user);
            });
        });

        const user = firebase.auth().currentUser;
        if (!user) {
            console.log('No user found');
            window.location.href = '/landing-page';
            return;
        }

        const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
        const userData = userDoc.data();

        // Handle user display and banners based on user type
        if (userData.isGuest) {
            document.getElementById('userEmail').textContent = 'Guest User';
            
            // Add guest banner
            if (bannerContainer) {
                bannerContainer.innerHTML = `
                    <div class="emergency-banner guest-banner">
                        <div class="emergency-content">
                            <span class="emergency-text">You are browsing as a guest. Create an account to add needs or donations.</span>
                            <a href="/signup" class="emergency-link">Create Account</a>
                        </div>
                    </div>
                `;
            }
        } else {
            document.getElementById('userEmail').textContent = user.email;
            
            // Add help banner for regular users if not closed
            if (!isBannerClosed() && bannerContainer) {
                bannerContainer.innerHTML = `
                    <div class="emergency-banner help-banner" id="helpBanner">
                        <div class="emergency-content">
                            <span class="emergency-dot help-dot">‚óè</span>
                            <span class="emergency-text help-text">Want to edit your needs and donations? Press your email on the top right to reach your profile.</span>
                            <a href="#" class="emergency-link help-link" onclick="closeBannerAndGoToProfile(event)">Profile</a>
                        </div>
                        <button class="banner-close-btn" onclick="closeBanner()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                `;
            }
        }

        // Rest of your initialization code...
        userLocation = userData.location;
        if (!userLocation) {
            window.location.href = '/setup-location';
            return;
        }

        updateDonationCenters(userData);

        document.getElementById('radiusFilter').addEventListener('change', () => {
            updateDonationCenters(userData);
        });

        // Show welcome popup if needed for non-guest users
        if (!userData.isGuest && 
            (!userData.canDonate || userData.canDonate.length === 0) && 
            (!userData.needs || userData.needs.length === 0)) {
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h2>Welcome!</h2>
                    <p>Let's get started by adding what you need or what you can donate.</p>
                    <div class="popup-buttons">
                        <button onclick="addNeeds()">Add Needs</button>
                        <button onclick="addDonations()">Add Donations</button>
                    </div>
                    <div class="form-buttons" style="margin-top: 1rem;">
                        <button onclick="closePopup()" type="button">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

    } catch (error) {
        console.error('Dashboard initialization error:', error);
        window.location.href = '/landing-page';
    }
});

       function showInitialPopup() {
            const popup = document.querySelector('.popup');
            popup.innerHTML = `
                <div class="popup-content">
                    <h2>Welcome!</h2>
                    <p>Let's get started by adding what you need or what you can donate.</p>
                    <div class="popup-buttons">
                        <button onclick="addNeeds()">Add Needs</button>
                        <button onclick="addDonations()">Add Donations</button>
                    </div>
                    <div class="form-buttons" style="margin-top: 1rem;">
                        <button onclick="closePopup()" type="button">Cancel</button>
                    </div>
                </div>
            `;
}

        function addNeeds() {
            const popup = document.querySelector('.popup');
            popup.innerHTML = `
                <div class="popup-content form-popup">
                    <h2>Add What You Need</h2>
                    <form id="needsForm">
                        <div id="needsContainer">
                            <div class="needs-row">
                                <div class="input-group">
                                    <label for="itemName_0">Item</label>
                                    <input type="text" id="itemName_0" required>
                                </div>
                                <div class="input-group">
                                    <label for="quantity_0">Quantity</label>
                                    <input type="number" id="quantity_0" min="1" placeholder="Optional">
                                </div>
                                <div class="input-group urgency-group">
                                    <label>Urgency</label>
                                    <div class="urgency-selector" id="urgency_0">
                                        <div class="urgency-segment low-urgency" data-urgency="low" onclick="selectUrgency(this)">Low</div>
                                        <div class="urgency-segment medium-urgency" data-urgency="medium" onclick="selectUrgency(this)">Medium</div>
                                        <div class="urgency-segment high-urgency" data-urgency="high" onclick="selectUrgency(this)">High</div>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="notes_0">Notes</label>
                                    <input type="text" id="notes_0">
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="addNeedRow()" class="add-row-btn">+ Add Another Item</button>
                        <div class="form-buttons">
                            <button type="submit">Submit</button>
                            <button type="button" onclick="showInitialPopup()">Back</button>
                        </div>
                    </form>
                </div>
            `;
            setTimeout(initializeItemDropdowns, 0);
            // Add global function for urgency selection
            window.selectUrgency = function(element) {
                const parent = element.closest('.urgency-selector');
                // Remove active class from all segments
                parent.querySelectorAll('.urgency-segment').forEach(segment => {
                    segment.classList.remove('active');
                });
                // Add active class to clicked segment
                element.classList.add('active');
            };

            let rowCount = 1;

            window.addNeedRow = function() {
                const container = document.getElementById('needsContainer');
                const newRow = document.createElement('div');
                newRow.className = 'needs-row';
                newRow.innerHTML = `
                    <div class="input-group">
                        <label for="itemName_${rowCount}">Item</label>
                        <input type="text" id="itemName_${rowCount}" required>
                    </div>
                    <div class="input-group">
                        <label for="quantity_${rowCount}">Quantity</label>
                        <input type="number" id="quantity_${rowCount}" min="1" placeholder="Optional">
                    </div>
                    <div class="input-group urgency-group">
                        <label>Urgency</label>
                        <div class="urgency-selector" id="urgency_${rowCount}">
                            <div class="urgency-segment low-urgency" data-urgency="low" onclick="selectUrgency(this)">Low</div>
                            <div class="urgency-segment medium-urgency" data-urgency="medium" onclick="selectUrgency(this)">Medium</div>
                            <div class="urgency-segment high-urgency" data-urgency="high" onclick="selectUrgency(this)">High</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="notes_${rowCount}">Notes</label>
                        <input type="text" id="notes_${rowCount}">
                    </div>
                    <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">√ó</button>
                `;
                setTimeout(initializeItemDropdowns, 0);
                container.appendChild(newRow);
                rowCount++;
            };
            

            document.getElementById('needsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateItemInputs('needsForm')) return;
                try {
                    const user = firebase.auth().currentUser;
                    const needItems = [];

                    const rows = document.querySelectorAll('.needs-row');
                    rows.forEach((row, index) => {
                        const quantity = document.getElementById(`quantity_${index}`).value;
                        const urgencySelector = document.getElementById(`urgency_${index}`);
                        const activeUrgency = urgencySelector.querySelector('.active');
                        
                        needItems.push({
                            itemName: document.getElementById(`itemName_${index}`).value,
                            quantity: quantity ? parseInt(quantity) : null,
                            urgency: activeUrgency ? activeUrgency.dataset.urgency : 'low',
                            notes: document.getElementById(`notes_${index}`).value,
                            timestamp: new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })
                        });
                    });

                    const userRef = firebase.firestore().collection('users').doc(user.uid);
                    await userRef.update({
                        needs: firebase.firestore.FieldValue.arrayUnion(...needItems)
                    });
                    showInitialPopup();

                    document.addEventListener('DOMContentLoaded', function() {
                    // Check if banner was previously closed
                    if (!localStorage.getItem('helpBannerClosed')) {
                        const banner = `
                            <div class="emergency-banner help-banner" id="helpBanner">
                                <div class="emergency-content">
                                    <span class="emergency-dot help-dot">‚óè</span>
                                    <span class="emergency-text help-text">Want to edit needs and donations? Press your email on the top right to reach your profile.</span>
                                    <a href="#" class="emergency-link help-link" onclick="closeBannerAndGoToProfile(event)">Profile</a>
                                </div>
                                <button class="banner-close-btn" onclick="closeBanner()">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        `;
                        document.getElementById('helpBannerContainer').innerHTML = banner;
                    }
                });

                } catch (error) {
                    console.error('Error adding needs:', error);
                    alert('Error adding needs. Please try again.');
                }
            });
        }

       function addDonations() {
           const popup = document.querySelector('.popup');
           popup.innerHTML = `
               <div class="popup-content form-popup">
                   <h2>Add What You Can Donate</h2>
                   <form id="donateForm">
                       <div id="donationsContainer">
                           <div class="needs-row">
                               <div class="input-group">
                                   <label for="itemName_0">Item</label>
                                   <input type="text" id="itemName_0" required>
                               </div>
                               <div class="input-group">
                                   <label for="quantity_0">Quantity</label>
                                   <input type="number" id="quantity_0" min="1" placeholder="Optional">
                               </div>
                               <div class="input-group">
                                   <label for="notes_0">Notes</label>
                                   <input type="text" id="notes_0">
                               </div>
                           </div>
                       </div>
                       <button type="button" onclick="addDonationRow()" class="add-row-btn">+ Add Another Item</button>
                       <div class="form-buttons">
                            <button type="submit">Submit</button>
                            <button type="button" onclick="showInitialPopup()">Back</button>
                        </div>
                   </form>
               </div>
           `;

           setTimeout(initializeItemDropdowns, 0);
           let rowCount = 1;

           window.addDonationRow = function() {
               const container = document.getElementById('donationsContainer');
               const newRow = document.createElement('div');
               newRow.className = 'needs-row';
               newRow.innerHTML = `
                   <div class="input-group">
                       <label for="itemName_${rowCount}">Item</label>
                       <input type="text" id="itemName_${rowCount}" required>
                   </div>
                   <div class="input-group">
                       <label for="quantity_${rowCount}">Quantity</label>
                       <input type="number" id="quantity_${rowCount}" min="1" placeholder="Optional">
                   </div>
                   <div class="input-group">
                       <label for="notes_${rowCount}">Notes</label>
                       <input type="text" id="notes_${rowCount}">
                   </div>
                   <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">√ó</button>
               `;
               setTimeout(initializeItemDropdowns, 0);
               container.appendChild(newRow);
               rowCount++;
           };

           document.getElementById('donateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = firebase.auth().currentUser;
                const donationItems = [];

                const rows = document.querySelectorAll('.needs-row');
                rows.forEach((row, index) => {
                    const quantity = document.getElementById(`quantity_${index}`).value;
                    donationItems.push({
                        itemName: document.getElementById(`itemName_${index}`).value,
                        quantity: quantity ? parseInt(quantity) : null,
                        notes: document.getElementById(`notes_${index}`).value,
                        timestamp: new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })
                    });
                });

                const userRef = firebase.firestore().collection('users').doc(user.uid);
                await userRef.update({
                    canDonate: firebase.firestore.FieldValue.arrayUnion(...donationItems)
                });
                showInitialPopup();  // Changed this line from closePopup()
            } catch (error) {
                console.error('Error adding donations:', error);
                alert('Error adding donations. Please try again.');
            }
        });
       }

       function highlightMatchingItems(userData, centerData) {
    // Ensure we're running after DOM is fully updated
    setTimeout(() => {
        console.log('Highlighting matching items');
        console.log('userData:', userData);
        console.log('centerData:', centerData);

        // Default to empty arrays if needed
        const userNeeds = userData?.needs || [];
        const userDonateItems = userData?.canDonate || [];

        // Use multiple selectors to find items
        const inventorySelectors = [
            '.matches-section.matches-inventory .match-item',
            '.matches-inventory .match-item',
            '.center-card .match-item'
        ];

        const needSelectors = [
            '.matches-section.matches-needs .match-item',
            '.matches-needs .match-item',
            '.center-card .match-item'
        ];

        // Function to find first matching elements
        function findElements(selectors) {
            for (let selector of selectors) {
                const elements = document.querySelectorAll(selector);
                if (elements.length > 0) {
                    console.log(`Found elements with selector: ${selector}`, elements);
                    return elements;
                }
            }
            console.log('No elements found with any selector');
            return [];
        }

        const inventoryItems = findElements(inventorySelectors);
        const needItems = findElements(needSelectors);

        console.log('Inventory Items:', inventoryItems);
        console.log('Need Items:', needItems);

        // Highlight inventory items that match user needs
        inventoryItems.forEach(inventoryItem => {
            const inventoryName = inventoryItem.textContent.trim().toLowerCase();
            
            const match = userNeeds.some(userNeed => {
                const needName = userNeed?.itemName?.toLowerCase() || '';
                return needName === inventoryName;
            });

            console.log(`Inventory item ${inventoryName} match:`, match);

            if (match) {
                inventoryItem.classList.add('highlight-match');
            }
        });

        // Highlight need items that match user donations
        needItems.forEach(needItem => {
            const needName = needItem.textContent.trim().toLowerCase();
            
            const match = userDonateItems.some(userItem => {
                const donationName = userItem?.itemName?.toLowerCase() || '';
                return donationName === needName;
            });

            console.log(`Need item ${needName} match:`, match);

            if (match) {
                needItem.classList.add('highlight-match');
            }
        });
    }, 100); // Short delay to ensure DOM is updated
}

function openUpdatesPopup(event) {
    event.preventDefault();
    
    const popup = document.createElement('div');
    popup.className = 'emergency-popup';
    
    popup.innerHTML = `
        <div class="emergency-popup-content">
            <div class="emergency-popup-header">
                <h2 class="emergency-popup-title">Emergency Updates</h2>
                <button onclick="closeEmergencyPopup()" class="emergency-popup-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="emergency-popup-body">
                <div class="twitter-timeline-wrapper">
                    <div id="loading-indicator" class="loading-indicator">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading Twitter updates...</div>
                    </div>
                    <div id="twitter-embed">
                        <a class="twitter-timeline" 
                           data-height="600"
                           data-chrome="noheader nofooter transparent"
                           href="https://twitter.com/LACoFDPIO">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);

    // Close popup when clicking outside
    popup.addEventListener('click', function(e) {
        if (e.target === popup) {
            closeEmergencyPopup();
        }
    });
    
    // Load Twitter widget script if not already loaded
    if (!document.querySelector('script[src="https://platform.twitter.com/widgets.js"]')) {
        const script = document.createElement('script');
        script.src = 'https://platform.twitter.com/widgets.js';
        script.async = true;
        
        // Add event listener for when Twitter widgets load
        script.onload = function() {
            if (window.twttr) {
                window.twttr.ready(function() {
                    window.twttr.events.bind('rendered', function() {
                        const loadingIndicator = document.getElementById('loading-indicator');
                        if (loadingIndicator) {
                            loadingIndicator.style.display = 'none';
                        }
                    });
                });
            }
        };
        
        document.body.appendChild(script);
    } else {
        // If script is already loaded, just bind the event
        if (window.twttr) {
            window.twttr.ready(function() {
                window.twttr.events.bind('rendered', function() {
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                });
            });
        }
    }
}

function closeEmergencyPopup() {
    const popup = document.querySelector('.emergency-popup');
    if (popup) {
        popup.remove();
    }
}

async function closePopup() {
    const popup = document.querySelector('.popup');
    if (popup) {
        popup.remove();
    }
    
    try {
        const user = firebase.auth().currentUser;
        const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
        const userData = userDoc.data();

        updateDonationCenters(userData);
    } catch (error) {
        console.error('Error updating donation centers:', error);
    }
}

async function goToProfile(event) {
            event.preventDefault();
            const user = firebase.auth().currentUser;
            if (user) {
                const token = await user.getIdToken();
                const url = new URL('/neighbor-profile', window.location.origin);
                url.searchParams.append('token', token);
                window.location.href = url.toString();
            }
        }

function setBannerClosed() {
    sessionStorage.setItem('helpBannerClosed', 'true');
    localStorage.setItem('helpBannerClosed', 'true');
}

function isBannerClosed() {
    return sessionStorage.getItem('helpBannerClosed') === 'true' || 
           localStorage.getItem('helpBannerClosed') === 'true';
}

function closeBanner() {
    // Get both the banner container and the banner itself
    const bannerContainer = document.getElementById('bannerContainer');
    const helpBanner = document.getElementById('helpBanner');
    
    // Clear the container's content
    if (bannerContainer) {
        bannerContainer.innerHTML = '';
    }
    
    // Also try to remove the banner directly if it exists
    if (helpBanner) {
        helpBanner.remove();
    }
    
    // Set the banner as closed
    setBannerClosed();
}

function closeBannerAndGoToProfile(event) {
    event.preventDefault();
    setBannerClosed();
    goToProfile(event);
}

document.addEventListener('DOMContentLoaded', function() {
    // Add console logs for debugging
    console.log('Banner Closed Status:', isBannerClosed());

    // Only show banner if it hasn't been closed
    if (!isBannerClosed()) {
        const banner = `
    <div class="emergency-banner help-banner" id="helpBanner">
        <div class="emergency-content">
            <span class="emergency-dot help-dot">‚óè</span>
            <span class="emergency-text help-text">Want to edit your needs and donations? Press your email on the top right to reach your profile.</span>
            <a href="#" class="emergency-link help-link" onclick="closeBannerAndGoToProfile(event)">Profile</a>
        </div>
        <button class="banner-close-btn" id="bannerCloseBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
`;

const bannerContainer = document.getElementById('bannerContainer');
if (bannerContainer) {
    bannerContainer.innerHTML = banner;
    // Attach event listener after banner is added to DOM
    document.getElementById('bannerCloseBtn').addEventListener('click', closeBanner);
}
    }
});

   </script>
</body>
</html>