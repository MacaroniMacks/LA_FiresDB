<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard</title>
    <link rel="stylesheet" href="/static/css/companyDash.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">EnergyBalance</div>
        <div class="nav-links">
            <span id="userEmail"></span>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>              
    </nav>

    <div class="dashboard-container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="switchTab('campaigns')">Campaigns</div>
        </div>

        <div id="dashboard" class="tab-content active">
            <!-- Dashboard content will go here -->
            <h2>Welcome to your Customer Dashboard</h2>
            <p>Placeholder for dashboard content</p>
        </div>

        <div id="campaigns" class="tab-content" style="display: none;">
            <!-- Campaigns content will go here -->
            <h2>Campaigns</h2>
            <p>Placeholder for campaigns content</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>

    <!-- Auth -->
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>

    <script>
        // Tab switching function
        function switchTab(tabName) {
            // Remove active class from all tabs and tab contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

            // Add active class to selected tab
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Show selected tab content
            document.getElementById(tabName).style.display = 'block';
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Get token
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.log('No token found');
                    window.location.href = '/login';
                    return;
                }

                // Set up auth header for all fetch requests first
                const originalFetch = window.fetch;
                window.fetch = function() {
                    let [resource, config] = arguments;
                    config = config || {};
                    config.headers = config.headers || {};
                    config.headers['Authorization'] = `Bearer ${token}`;
                    return originalFetch(resource, config);
                };

                // Then set up Firebase auth listener
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        const userDoc = await firebase.firestore()
                            .collection('users')
                            .doc(user.uid)
                            .get();
                        
                        const userData = userDoc.data();
                        document.getElementById('userEmail').textContent = user.email;

                        if (!userData.isCompany) {
                            window.location.href = '/customer-dashboard';
                        }
                    }
                    // Don't redirect to login here - just don't load content
                });

            } catch (error) {
                console.error('Dashboard initialization error:', error);
                window.location.href = '/login';
            }
        });
    </script>
</body>
</html>