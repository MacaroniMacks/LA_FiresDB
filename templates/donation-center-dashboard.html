<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donation Center Dashboard</title>
    <link rel="stylesheet" href="/static/css/donationcenterDash.css">
    <link rel="stylesheet" href="/static/css/item-dropdown-styles.css">
    <link rel="stylesheet" href="/static/css/navBar.css">
    <script src="/static/js/item-searchable-dropdown.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <img src="static\images\Logo.png" alt="Logo" class="nav-logo">
        </div>
        <div class="nav-links">
            <a href="#" id="userEmail" onclick="goToProfile(event)"></a>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>              
    </nav>

    <div class="dashboard-container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('analytics')">Analytics</div>
            <div class="tab" onclick="switchTab('profile')">Profile</div>
        </div>

        <div id="analytics" class="tab-content active">
            <h2>Welcome to your Analytics Dashboard</h2>
            <div class="filter-section">
                <select id="radiusFilter" onchange="updateAnalytics(centerLocation)">
                    <option value="5">Within 5 miles</option>
                    <option value="10">Within 10 miles</option>
                    <option value="25">Within 25 miles</option>
                    <option value="50">Within 50 miles</option>
                    <option value="999">Any distance</option>
                </select>

                <div class="input-group">
                    <label for="itemName_0"></label>
                    <input 
                        type="text" 
                        id="itemName_0" 
                        required 
                        oninput="updateAnalytics(centerLocation)"
                        onchange="updateAnalytics(centerLocation)"
                        onkeyup="updateAnalytics(centerLocation)"
                        onpaste="updateAnalytics(centerLocation)"
                    >
                </div>
            </div>

            <div class="neighbors-count">
                <span id="neighborCountText">Neighbors in Radius: <span id="neighborCount">0</span></span>
            </div>

            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>Item Demand Analysis</h3>
                    <div id="demandStats">
                        <div class="stat-row">
                            <span class="stat-label">Total Neighbors Needing:</span>
                            <span id="totalNeeding" class="stat-value">0</span>
                        </div>
                        <div class="urgency-breakdown">
                            <div class="urgency-bar empty">
                                <div class="urgency-segment high" id="highUrgency"></div>
                                <div class="urgency-segment medium" id="mediumUrgency"></div>
                                <div class="urgency-segment low" id="lowUrgency"></div>
                            </div>
                            <div class="urgency-legend">
                                <span class="high">High</span>
                                <span class="medium">Medium</span>
                                <span class="low">Low</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3>Available Supply</h3>
                    <div id="supplyStats">
                        <div class="stat-row">
                            <span class="stat-label">Neighbors Able to Donate:</span>
                            <span id="totalDonors" class="stat-value">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Items Available:</span>
                            <span id="totalItems" class="stat-value">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="profile" class="tab-content" style="display: none;">
            <div class="preview-section">
                <div class="how-neighbors-see">How Neighbors Will See Your Center</div>
                <div id="centerCardPreview" class="center-card">
                    <div class="center-header">
                        <div class="center-main-info">
                            <h3 id="previewCenterName">Unnamed Center</h3>
                            <p id="previewPhone" class="contact-detail"></p>
                            <p id="previewEmail" class="contact-detail"></p>
                        </div>
                        <div class="center-location">
                            <div class="location-info">
                                <div class="address-wrapper" style="display: flex;">
                                    <svg class="svg-icon location-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                        <circle cx="12" cy="10" r="3"/>
                                    </svg>
                                    <span id="previewAddress"></span>
                                </div>
                                <span class="dot-separator"></span>
                                <span id="previewDistance">0 miles away</span>
                            </div>
                            <div class="center-hours" id="hoursOfOperation">
                                <h4 id="hoursStatus"></h4>
                                <div class="hours-popup">
                                    <div id="centerHours"></div>
                                </div>
                            </div>
                        </div>
                    </div>
            
                    <div class="additional-info">
                        <h4>Notes</h4>
                        <p id="previewNotes"></p>
                    </div>
            
                    <div class="matches-container">
                        <div class="matches-section matches-inventory">
                            <h4><svg class="svg-icon box-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                <polyline points="3.29 7 12 12 20.71 7"/>
                                <line x1="12" y1="22" x2="12" y2="12"/>
                            </svg>
                                <span>Center's Inventory</span>
                            </h4>
                            <ul id="previewInventory">
                                <li class="no-matches">Center currently hasn't set up inventory</li>
                            </ul>
                        </div>
                        <div class="matches-section matches-needs">
                            <h4> <svg class="svg-icon heart-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                <path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0 5.4 5.4 0 0 0 0 7.65l.77.78 7.65 7.65 7.65-7.65.77-.78a5.4 5.4 0 0 0 0-7.65z"/>
                            </svg>
                                <span>Center's Needs</span>
                            </h4>
                            <ul id="previewNeeds">
                                <li>
                                    <span class="match-item"></span>
                                    <span class="match-quantity"></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="center-info-section">
                <div class="profile-settings">
                    <h2>Center Information</h2>
                    <div class="settings-grid">
                        <div class="settings-section">
                            <h3>Hours of Operations</h3>
                            <div class="hours-grid">
                                <div class="day-row">
                                    <label>M</label>
                                    <input type="time" id="monOpen">
                                    <span>to</span>
                                    <input type="time" id="monClose">
                                </div>
                                <div class="day-row">
                                    <label>T</label>
                                    <input type="time" id="tueOpen">
                                    <span>to</span>
                                    <input type="time" id="tueClose">
                                </div>
                                <div class="day-row">
                                    <label>W</label>
                                    <input type="time" id="wedOpen">
                                    <span>to</span>
                                    <input type="time" id="wedClose">
                                </div>
                                <div class="day-row">
                                    <label>TH</label>
                                    <input type="time" id="thuOpen">
                                    <span>to</span>
                                    <input type="time" id="thuClose">
                                </div>
                                <div class="day-row">
                                    <label>F</label>
                                    <input type="time" id="friOpen">
                                    <span>to</span>
                                    <input type="time" id="friClose">
                                </div>
                                <div class="day-row">
                                    <label>SAT</label>
                                    <input type="time" id="satOpen">
                                    <span>to</span>
                                    <input type="time" id="satClose">
                                </div>
                                <div class="day-row">
                                    <label>SUN</label>
                                    <input type="time" id="sunOpen">
                                    <span>to</span>
                                    <input type="time" id="sunClose">
                                </div>
                            </div>
                        </div>
                
                        <div class="settings-section">
                            <h3>Contact Information</h3>
                            <div class="form-group">
                                <label for="phoneNumber">Phone Number</label>
                                <input type="tel" id="phoneNumber" placeholder="(626) 555-0123" oninput="formatPhoneNumber(event)">
                            </div>
                            <div class="form-group">
                                <label for="contactEmail">Contact Email</label>
                                <input type="email" id="contactEmail" placeholder="contact@help626.org" onblur="validateEmail()">
                                <span id="emailError" style="color: red; display: none;">Please enter a valid email address with "@" and ".com"</span>
                            </div>
                            
                        </div>
                
                        <div class="settings-section">
                            <h3>Location Information</h3>
                            <div class="form-group">
                                <label for="streetAddress">Street Address</label>
                                <input type="text" id="streetAddress" placeholder="123 Main St">
                            </div>
                            <div class="form-group">
                                <label for="unit">Unit/Suite (Optional)</label>
                                <input type="text" id="unit" placeholder="Suite 100">
                            </div>
                            <div class="address-group">
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" id="city" placeholder="Pasadena">
                                </div>
                                <div class="form-group">
                                    <label for="zipCode">ZIP Code</label>
                                    <input type="text" id="zipCode" placeholder="91101">
                                </div>
                            </div>
                        </div>
                
                        <div class="settings-section">
                            <h3>Additional Notes</h3>
                            <div class="form-group">
                                <label for="centerNotes">Notes (visible to neighbors)</label>
                                <textarea id="centerNotes" rows="5" placeholder="Enter any additional information that neighbors should know about your center..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="save-btn" onclick="saveProfileChanges()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>

    <!-- Auth -->
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>

    <script>
        let centerLocation;

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function toRad(degrees) {
            return degrees * (Math.PI/180);
        }

        function getCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function convertTo12HourFormat(time) {
            if (!time) return '';
            let [hour, minute] = time.split(':');
            hour = parseInt(hour);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12;
            hour = hour ? hour : 12; // the hour '0' should be '12'
            minute = minute.padStart(2, '0');
            return `${hour}:${minute} ${ampm}`;
        }

        function generateHoursHTML(hours) {
    if (!hours) return '';
    
    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const currentDay = days[new Date().getDay()];
    const currentDate = new Date();
    
    // Check if any days have hours set
    const hasAnyHours = days.some(day => {
        const dayHours = hours[day];
        return dayHours && dayHours.open && dayHours.close;
    });

    // If no days have hours set, don't return any hours display
    if (!hasAnyHours) {
        return '';
    }

    const todayHours = hours[currentDay];
    let statusText = 'Closed';

    if (todayHours && todayHours.open && todayHours.close) {
        const [openHour, openMinute] = todayHours.open.split(':').map(Number);
        const [closeHour, closeMinute] = todayHours.close.split(':').map(Number);
        const openTime = new Date();
        openTime.setHours(openHour, openMinute, 0);
        const closeTime = new Date();
        closeTime.setHours(closeHour, closeMinute, 0);

        // Handle cases where closing time is past midnight
        if (closeTime < openTime) {
            closeTime.setDate(closeTime.getDate() + 1);
        }

        if (currentDate >= openTime && currentDate <= closeTime) {
            statusText = `Open until ${convertTo12HourFormat(todayHours.close)}`;
        }
    }
    
    // If not currently open, always check future days for next opening
    if (statusText === 'Closed') {
        // Find the next open day
        let foundOpenDay = false;
        
        // Check today (if there are hours) and up to 7 days ahead
        for (let i = 0; i < 7; i++) {
            const checkIndex = (days.indexOf(currentDay) + i) % 7;
            const checkDay = days[checkIndex];
            const dayHours = hours[checkDay];
            
            if (dayHours && dayHours.open) {
                const [nextOpenHour, nextOpenMinute] = dayHours.open.split(':').map(Number);
                const nextOpenTime = new Date();
                nextOpenTime.setHours(nextOpenHour, nextOpenMinute, 0);
                
                if (i === 0) {
                    // Today: only show if the opening time hasn't passed
                    if (currentDate < nextOpenTime) {
                        statusText = `Closed until ${convertTo12HourFormat(dayHours.open)}`;
                        foundOpenDay = true;
                        break;
                    }
                } else {
                    // Future days
                    if (i === 1) {
                        statusText = `Closed until ${convertTo12HourFormat(dayHours.open)} tomorrow`;
                    } else {
                        const dayName = checkDay.charAt(0).toUpperCase() + checkDay.slice(1);
                        statusText = `Closed until ${convertTo12HourFormat(dayHours.open)} ${dayName}`;
                    }
                    foundOpenDay = true;
                    break;
                }
            }
        }
    }

    const popupContent = days.map(day => {
        const dayHours = hours[day];
        if (dayHours?.open && dayHours?.close) {
            return `<div class="day-hours">
                ${day.charAt(0).toUpperCase() + day.slice(1)}: 
                ${convertTo12HourFormat(dayHours.open)} - ${convertTo12HourFormat(dayHours.close)}
            </div>`;
        }
        return `<div class="day-hours">${day.charAt(0).toUpperCase() + day.slice(1)}: Closed</div>`;
    }).join('');

    const statusClass = statusText.toLowerCase().includes('open') ? 'hours-status-open' : 'hours-status-closed';

    return `
        <div class="center-hours">
            <h4 class="${statusClass}">${statusText}</h4>
            <div class="hours-popup">
                <div class="hours-content">
                    ${popupContent}
                </div>
            </div>
        </div>
    `;
}

function updateCenterCardPreview(userData) {
    if (!userData) {
        console.error('No user data provided to updateCenterCardPreview');
        return;
    }

    // Update center name
    const centerNameEl = document.getElementById('previewCenterName');
    if (centerNameEl) {
        centerNameEl.textContent = userData.centerName || 'Unnamed Center';
    }

    // Update address and location elements
    const addressEl = document.getElementById('previewAddress');
    const addressWrapper = document.querySelector('.address-wrapper');
    const dotSeparator = document.querySelector('.dot-separator');
    const distanceEl = document.getElementById('previe  wDistance');
    const locationIcon = document.querySelector('.location-icon');

    // Check if we have valid address info
    const hasValidAddress = userData.addressInfo && 
        userData.addressInfo.street && 
        userData.addressInfo.city && 
        userData.addressInfo.zipCode;

    // Handle address elements visibility
    if (hasValidAddress) {
        // Show address-related elements
        if (addressWrapper) addressWrapper.style.display = 'flex';
        if (locationIcon) locationIcon.style.display = 'block';
        if (dotSeparator) dotSeparator.style.display = 'block';
        
        // Update address text
        if (addressEl) {
            let address = [
                userData.addressInfo.street,
                userData.addressInfo.unit ? `Unit ${userData.addressInfo.unit}` : null,
                userData.addressInfo.city,
                userData.addressInfo.zipCode
            ].filter(Boolean).join(', ');
            addressEl.textContent = address;
        }
    } else {
        // Hide address-related elements
        if (addressWrapper) addressWrapper.style.display = 'none';
        if (locationIcon) locationIcon.style.display = 'none';
        if (dotSeparator) dotSeparator.style.display = 'none';
        
        if (addressEl) {
            addressEl.textContent = '';
        }
    }

    // Always show distance if we have coordinates
    if (distanceEl && userData.location) {
        distanceEl.style.display = 'inline';
        distanceEl.textContent = '0 miles away';
    } else if (distanceEl) {
        distanceEl.style.display = 'none';
    }

    // Update phone and email
    const phoneEl = document.getElementById('previewPhone');
    const emailEl = document.getElementById('previewEmail');
    
    if (phoneEl && emailEl && userData.contactInfo) {
        // Phone number handling
        if (userData.contactInfo.phone) {
            phoneEl.innerHTML = `
                <svg class="phone-icon" style="transform: translateY(2px)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                ${userData.contactInfo.phone}`;
            phoneEl.style.display = 'block';
        } else {
            phoneEl.innerHTML = '';
            phoneEl.style.display = 'none';
        }

        // Email handling
        if (userData.contactInfo.email) {
            emailEl.innerHTML = `
                <svg class="email-icon" style="transform: translateY(4px)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                ${userData.contactInfo.email}`;
            emailEl.style.display = 'block';
        } else {
            emailEl.innerHTML = '';
            emailEl.style.display = 'none';
        }
    }

    // Update hours
    const hoursContainer = document.getElementById('hoursOfOperation');
    if (hoursContainer && userData.operatingHours) {
        const hoursHTML = generateHoursHTML(userData.operatingHours);
        if (hoursHTML) {
            hoursContainer.innerHTML = hoursHTML;
            hoursContainer.style.display = 'block';
        } else {
            hoursContainer.style.display = 'none';
        }
    }

    // Update notes
    const notesEl = document.getElementById('previewNotes');
    if (notesEl) {
        notesEl.textContent = userData.centerNotes || 'No additional information provided';
    }

    // Update inventory
    const inventoryListEl = document.getElementById('previewInventory');
    if (inventoryListEl) {
        if (Array.isArray(userData.inventory) && userData.inventory.length > 0) {
            inventoryListEl.innerHTML = userData.inventory.map(item => `
                <li>
                    <span class="match-item">${item.itemName || 'Unnamed Item'}</span>
                    ${item.quantity ? `<span class="match-quantity">(${item.quantity} available)</span>` : ''}
                </li>
            `).join('');
        } else {
            inventoryListEl.innerHTML = '<li class="no-matches">Center currently hasn\'t set up inventory</li>';
        }
    }

    // Update needs
    const needsListEl = document.getElementById('previewNeeds');
    if (needsListEl) {
        if (Array.isArray(userData.needs) && userData.needs.length > 0) {
            needsListEl.innerHTML = userData.needs.map(need => `
                <li>
                    <span class="match-item">${need.itemName || 'Unnamed Item'}</span>
                    ${need.quantity ? `<span class="match-quantity">(${need.quantity} needed)</span>` : ''}
                    ${need.urgency ? `<span class="urgency-tag ${need.urgency}-urgency">${need.urgency} urgency</span>` : ''}
                </li>
            `).join('');
        } else {
            needsListEl.innerHTML = '<li class="no-matches">Center currently hasn\'t set up needs</li>';
        }
    }
}

function loadCenterInformation(userData) {
    if (!userData) return;

    // Load hours
    if (userData.operatingHours) {
        const hours = userData.operatingHours;
        if (hours.monday) {
            document.getElementById('monOpen').value = hours.monday.open || '';
            document.getElementById('monClose').value = hours.monday.close || '';
        }
        if (hours.tuesday) {
            document.getElementById('tueOpen').value = hours.tuesday.open || '';
            document.getElementById('tueClose').value = hours.tuesday.close || '';
        }
        if (hours.wednesday) {
            document.getElementById('wedOpen').value = hours.wednesday.open || '';
            document.getElementById('wedClose').value = hours.wednesday.close || '';
        }
        if (hours.thursday) {
            document.getElementById('thuOpen').value = hours.thursday.open || '';
            document.getElementById('thuClose').value = hours.thursday.close || '';
        }
        if (hours.friday) {
            document.getElementById('friOpen').value = hours.friday.open || '';
            document.getElementById('friClose').value = hours.friday.close || '';
        }
        if (hours.saturday) {
            document.getElementById('satOpen').value = hours.saturday.open || '';
            document.getElementById('satClose').value = hours.saturday.close || '';
        }
        if (hours.sunday) {
            document.getElementById('sunOpen').value = hours.sunday.open || '';
            document.getElementById('sunClose').value = hours.sunday.close || '';
        }
    }

    // Load contact info
    if (userData.contactInfo) {
        document.getElementById('phoneNumber').value = userData.contactInfo.phone || '';
        document.getElementById('contactEmail').value = userData.contactInfo.email || '';
    }

    // Load location info
    if (userData.addressInfo) {
        document.getElementById('streetAddress').value = userData.addressInfo.street || '';
        document.getElementById('unit').value = userData.addressInfo.unit || '';
        document.getElementById('city').value = userData.addressInfo.city || '';
        document.getElementById('zipCode').value = userData.addressInfo.zipCode || '';
    }

    // Load notes
    document.getElementById('centerNotes').value = userData.centerNotes || '';
}

function itemsMatch(searchItem, targetItem) {
    // If either item is null/undefined, no match
    if (!searchItem || !targetItem) return false;
    
    // Convert both to lowercase and trim
    searchItem = searchItem.toLowerCase().trim();
    targetItem = targetItem.toLowerCase().trim();
    
    // If search is empty, it matches nothing
    if (searchItem === '') return false;
    
    console.log(`Comparing items - Search: "${searchItem}", Target: "${targetItem}"`);
    
    // Only do exact matches
    const isMatch = searchItem === targetItem;
    if (isMatch) {
        console.log('Exact match found');
    } else {
        console.log('No match found');
    }
    return isMatch;
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).style.display = 'block';
        }

        async function updateAnalytics(centerLocation) {
    if (!centerLocation || !centerLocation.latitude || !centerLocation.longitude) {
        return;
    }

    const radius = parseFloat(document.getElementById('radiusFilter').value);
    const itemFilterInput = document.getElementById('itemName_0');
        
    if (!itemFilterInput) {
        return;
    }

    const searchItem = itemFilterInput.value.trim().toLowerCase();
    
    try {
        const neighborsSnapshot = await firebase.firestore()
            .collection('users')
            .where('isDonationCenter', '==', false)
            .get();

        let needsCount = { high: 0, medium: 0, low: 0 };
        let donorsCount = 0;
        let totalItemsAvailable = 0;
        let neighborsInRadius = 0;

        neighborsSnapshot.forEach(doc => {
            const neighborData = doc.data();
            
            if (!neighborData.location) {
                return;
            }

            const distance = calculateDistance(
                centerLocation.latitude,
                centerLocation.longitude,
                neighborData.location.latitude,
                neighborData.location.longitude
            );

            if (distance <= radius || radius === 999) {
                neighborsInRadius++;
                
                // Only process item-specific counts if there's a search term
                if (searchItem && neighborData.needs) {
                    neighborData.needs.forEach(need => {
                        const itemNameLower = need.itemName?.toLowerCase() || '';
                        if (itemNameLower === searchItem) {
                            needsCount[need.urgency || 'low']++;
                        }
                    });
                }

                if (searchItem && neighborData.canDonate) {
                    let neighborItemsAvailable = 0;
                    neighborData.canDonate.forEach(item => {
                        const itemNameLower = item.itemName?.toLowerCase() || '';
                        
                        if (itemNameLower === searchItem) {
                            const quantity = Number(item.quantity) || 1;
                            neighborItemsAvailable += quantity;
                        }
                    });

                    // Only increment donors if they have any matching items
                    if (neighborItemsAvailable > 0) {
                        donorsCount++;
                        totalItemsAvailable += neighborItemsAvailable;
                    }
                }
            }
        });

        // Always update neighbors count
        document.getElementById('neighborCount').textContent = neighborsInRadius.toString();

        // Update item-specific stats
        if (!searchItem) {
            document.getElementById('totalNeeding').textContent = '0';
            document.getElementById('totalDonors').textContent = '0';
            document.getElementById('totalItems').textContent = '0';
            const urgencyBar = document.querySelector('.urgency-bar');
            if (urgencyBar) {
                urgencyBar.classList.add('empty');
                document.getElementById('highUrgency').style.width = '0%';
                document.getElementById('mediumUrgency').style.width = '0%';
                document.getElementById('lowUrgency').style.width = '0%';
            }
            return;
        }

        // Update urgency bar and other stats if there's a search term
        const totalNeeds = needsCount.high + needsCount.medium + needsCount.low;
        const urgencyBar = document.querySelector('.urgency-bar');

        if (totalNeeds === 0) {
            urgencyBar.classList.add('empty');
            document.getElementById('highUrgency').style.width = '0%';
            document.getElementById('mediumUrgency').style.width = '0%';
            document.getElementById('lowUrgency').style.width = '0%';
        } else {
            urgencyBar.classList.remove('empty');
            document.getElementById('highUrgency').style.width = 
                `${(needsCount.high / totalNeeds * 100) || 0}%`;
            document.getElementById('mediumUrgency').style.width = 
                `${(needsCount.medium / totalNeeds * 100) || 0}%`;
            document.getElementById('lowUrgency').style.width = 
                `${(needsCount.low / totalNeeds * 100) || 0}%`;
        }

        document.getElementById('totalNeeding').textContent = totalNeeds.toString();
        document.getElementById('totalDonors').textContent = donorsCount.toString();
        document.getElementById('totalItems').textContent = totalItemsAvailable.toString();

    } catch (error) {
        console.error('Error updating analytics:', error);
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            console.log('No token found');
            window.location.href = '/login';
            return;
        }

        const itemFilterInput = document.getElementById('itemName_0');

        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(user.uid)
                        .get();
                    
                    const userData = userDoc.data();
                    document.getElementById('userEmail').textContent = user.email;

                    if (!userData.isDonationCenter) {
                        window.location.href = '/neighbor-dashboard';
                        return;
                    }

                    // Robust location validation
                    if (!userData.location || 
                        typeof userData.location.latitude !== 'number' || 
                        typeof userData.location.longitude !== 'number') {
                        console.error('Invalid location data');
                        window.location.href = '/setup-location';
                        return;
                    }

                    // Set centerLocation with explicit type checking
                    centerLocation = {
                        latitude: Number(userData.location.latitude),
                        longitude: Number(userData.location.longitude)
                    };

                    // Update center card preview and load center information
                    updateCenterCardPreview(userData);
                    loadCenterInformation(userData);

                    // Call updateAnalytics immediately after setting location
                    await updateAnalytics(centerLocation);

                    // Add event listener for item filter input
                    if (itemFilterInput) {
                        itemFilterInput.addEventListener('input', () => {
                            debouncedUpdate(centerLocation);
                        });
                    }

                } catch (error) {
                    console.error('Error initializing user data:', error);
                    window.location.href = '/login';
                }
            } else {
                window.location.href = '/login';
            }
        });

    } catch (error) {
        console.error('Dashboard initialization error:', error);
        window.location.href = '/login';
    }
});

async function saveProfileChanges() {
    try {
        const user = firebase.auth().currentUser;
        if (!user) return;

        // Collect hours data
        const hours = {
            monday: {
                open: document.getElementById('monOpen').value || null,
                close: document.getElementById('monClose').value || null
            },
            tuesday: {
                open: document.getElementById('tueOpen').value || null,
                close: document.getElementById('tueClose').value || null
            },
            wednesday: {
                open: document.getElementById('wedOpen').value || null,
                close: document.getElementById('wedClose').value || null
            },
            thursday: {
                open: document.getElementById('thuOpen').value || null,
                close: document.getElementById('thuClose').value || null
            },
            friday: {
                open: document.getElementById('friOpen').value || null,
                close: document.getElementById('friClose').value || null
            },
            saturday: {
                open: document.getElementById('satOpen').value || null,
                close: document.getElementById('satClose').value || null
            },
            sunday: {
                open: document.getElementById('sunOpen').value || null,
                close: document.getElementById('sunClose').value || null
            }
        };

        // Collect contact and location information
        const contactInfo = {
            phone: document.getElementById('phoneNumber').value || null,
            email: document.getElementById('emailError').style.display === 'none' ? document.getElementById('contactEmail').value || null : null
            // If the email error message is hidden (no error), save the email input value. 
            // If the error is visible (email is invalid), set the email to null.
        };

        const locationInfo = {
            street: document.getElementById('streetAddress').value || null,
            unit: document.getElementById('unit').value || null,
            city: document.getElementById('city').value || null,
            zipCode: document.getElementById('zipCode').value || null
        };

        const centerNotes = document.getElementById('centerNotes').value || null;

        // Get current user data first
        const userRef = firebase.firestore().collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        const currentUserData = userDoc.data();

        // Create updated data object
        const updatedUserData = {
            ...currentUserData,  // Keep all existing data
            operatingHours: hours,
            contactInfo: {
                phone: contactInfo.phone,  // Always include phone
                email: document.getElementById('emailError').style.display === 'none' 
                    ? (document.getElementById('contactEmail').value.trim() || currentUserData.contactInfo?.email || null)  // Use new email, or keep existing, or send null
                    : currentUserData.contactInfo?.email  // Keep existing email if invalid
            },
            addressInfo: locationInfo,
            centerNotes: centerNotes,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };


        // Update in Firestore
        await userRef.update(updatedUserData);

        // Update the center card preview with the complete merged data
        updateCenterCardPreview(updatedUserData);

    } catch (error) {
        console.error('Error saving profile changes:', error);
        alert('Error saving changes. Please try again.');
    }
}

    function formatPhoneNumber(event) {
        let phoneInput = event.target;
        let formattedPhone = phoneInput.value.replace(/\D/g, ''); // Remove non-numeric characters
        if (formattedPhone.length > 3 && formattedPhone.length <= 6) {
            formattedPhone = `(${formattedPhone.slice(0, 3)}) ${formattedPhone.slice(3)}`;
        } else if (formattedPhone.length > 6) {
            formattedPhone = `(${formattedPhone.slice(0, 3)}) ${formattedPhone.slice(3, 6)}-${formattedPhone.slice(6, 10)}`;
        } else if (formattedPhone.length > 0) {
            formattedPhone = `(${formattedPhone.slice(0, 3)}) ${formattedPhone.slice(3)}`;
        }
        phoneInput.value = formattedPhone;
    }

    // Validate email to ensure it has "@" and ".com"
    function validateEmail() {
    let emailInput = document.getElementById('contactEmail');
    let emailValue = emailInput.value;
    let regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
    let emailError = document.getElementById('emailError');
    
    if (!regex.test(emailValue)) {
        // Show the error message
        emailError.style.display = 'block';
        emailInput.style.borderColor = 'red';  // Optional: add a red border to the input
    } else {
        // Hide the error message if the email is valid
        emailError.style.display = 'none';
        emailInput.style.borderColor = '';  // Remove the red border if valid
    }
}

        async function goToProfile(event) {
            event.preventDefault();
            const user = firebase.auth().currentUser;
            if (user) {
                const token = await user.getIdToken();
                const url = new URL('/donation-center-profile', window.location.origin);
                url.searchParams.append('token', token);
                window.location.href = url.toString();
            }
        }
    </script>
</body>
</html>