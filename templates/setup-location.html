<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Location</title>
    <link rel="stylesheet" href="/static/css/locationStyles.css">
    <!-- Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzIOcI6yLPH7uG5q-P8A_AGb6aGrLXO08"></script>
</head>
<body>
    <div class="map-container">
        <div id="map"></div>
        <div class="button-container">
            <button id="useCurrentLocation" class="location-button">Use My Location</button>
            <button id="confirmLocation" class="location-button" disabled>Confirm</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>

    <script>
        let map;
        let marker;
        let selectedLocation;

        function initMap() {
            // Default to LA area
            const defaultLocation = { lat: 34.0522, lng: -118.2437 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 10,
                center: defaultLocation,
                fullscreenControl: false,
                mapTypeControl: false,
                streetViewControl: false
            });

            // Click listener for the map
            map.addListener('click', (e) => {
                placeMarker(e.latLng);
            });
        }

        function placeMarker(location) {
            if (marker) {
                marker.setMap(null);
            }
            
            marker = new google.maps.Marker({
                position: location,
                map: map
            });

            selectedLocation = location;
            document.getElementById('confirmLocation').disabled = false;
        }

        document.getElementById('useCurrentLocation').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setCenter(pos);
                        placeMarker(pos);
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        alert('Error getting your location. Please pick a location on the map.');
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser. Please pick a location on the map.');
            }
        });

        document.getElementById('confirmLocation').addEventListener('click', async () => {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    window.location.href = '/login';
                    return;
                }

                await firebase.firestore().collection('users').doc(user.uid).update({
                    location: {
                        latitude: selectedLocation.lat(),
                        longitude: selectedLocation.lng(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }
                });

                // Redirect based on user type
                const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                const userData = userDoc.data();

                if (userData.isDonationCenter) {
                    window.location.href = '/donation-center-dashboard';
                } else {
                    window.location.href = '/neighbor-dashboard';
                }
            } catch (error) {
                console.error('Error saving location:', error);
                alert('Error saving your location. Please try again.');
            }
        });

        // Initialize the map and request location when the page loads
        window.onload = () => {
            initMap();
            
            // Automatically trigger location request
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setCenter(pos);
                        placeMarker(pos);
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        alert('Could not get your location. Please select a location on the map.');
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser. Please pick a location on the map.');
            }
        };
    </script>
</body>
</html>